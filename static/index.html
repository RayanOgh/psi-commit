<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PSI-COMMIT ‚Äî Prove You Said It First</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --black: #0a0a0a;
    --white: #f5f2eb;
    --cream: #ede9df;
    --accent: #c8f000;
    --accent2: #00f0c8;
    --mid: #1a1a1a;
    --border: #2a2a2a;
    --muted: #555;
    --mono: 'DM Mono', monospace;
    --display: 'Bebas Neue', sans-serif;
    --body: 'DM Sans', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }
  body {
    background: var(--black);
    color: var(--white);
    font-family: var(--body);
    font-size: 16px;
    line-height: 1.6;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 1000;
    opacity: 0.4;
  }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 100;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.2rem 2.5rem;
    border-bottom: 1px solid var(--border);
    background: rgba(10,10,10,0.92);
    backdrop-filter: blur(12px);
  }

  .nav-logo {
    font-family: var(--mono);
    font-size: 0.85rem;
    letter-spacing: 0.15em;
    color: var(--accent);
    text-transform: uppercase;
    text-decoration: none;
  }

  .nav-links {
    display: flex;
    gap: 2rem;
    list-style: none;
    align-items: center;
  }

  .nav-links a {
    font-family: var(--mono);
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    color: var(--muted);
    text-decoration: none;
    text-transform: uppercase;
    transition: color 0.2s;
  }

  .nav-links a:hover { color: var(--white); }

  .nav-auth {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .btn-login {
    font-family: var(--mono);
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.5rem 1.2rem;
    border: 1px solid var(--accent);
    background: transparent;
    color: var(--accent);
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-login:hover {
    background: var(--accent);
    color: var(--black);
  }

  .nav-avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid var(--border);
    transition: border-color 0.2s;
    object-fit: cover;
  }

  .nav-avatar:hover { border-color: var(--accent); }

  .nav-user {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    cursor: pointer;
    position: relative;
  }

  .nav-username {
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--white);
    letter-spacing: 0.05em;
  }

  .user-dropdown {
    position: absolute;
    top: calc(100% + 0.75rem);
    right: 0;
    background: #111;
    border: 1px solid var(--border);
    min-width: 160px;
    display: none;
    z-index: 200;
  }

  .user-dropdown.open { display: block; }

  .dropdown-item {
    display: block;
    padding: 0.75rem 1rem;
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--muted);
    text-decoration: none;
    cursor: pointer;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    letter-spacing: 0.05em;
    transition: all 0.15s;
    border-bottom: 1px solid var(--border);
  }

  .dropdown-item:last-child { border-bottom: none; }
  .dropdown-item:hover { background: #1a1a1a; color: var(--white); }
  .dropdown-item.danger:hover { color: #ff6060; }

  /* ‚îÄ‚îÄ AUTH MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 500;
    display: none;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: #111;
    border: 1px solid var(--border);
    padding: 2.5rem;
    max-width: 420px;
    width: 90%;
    position: relative;
  }

  .modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    color: var(--muted);
    font-size: 1.2rem;
    cursor: pointer;
    font-family: var(--mono);
  }

  .modal-close:hover { color: var(--white); }

  .modal-title {
    font-family: var(--display);
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .modal-sub {
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--muted);
    margin-bottom: 2rem;
    line-height: 1.6;
  }

  .btn-google {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.9rem;
    background: var(--white);
    color: #111;
    border: none;
    cursor: pointer;
    font-family: var(--mono);
    font-size: 0.78rem;
    letter-spacing: 0.08em;
    font-weight: 500;
    transition: all 0.2s;
  }

  .btn-google:hover {
    background: var(--accent);
    transform: translateY(-1px);
  }

  .google-icon {
    width: 18px;
    height: 18px;
  }

  /* ‚îÄ‚îÄ PROFILE PAGE ‚îÄ‚îÄ */
  #profile-page {
    display: none;
    padding-top: 5rem;
    min-height: 100vh;
  }

  #profile-page.active { display: block; }

  .profile-header {
    border-bottom: 1px solid var(--border);
    padding: 4rem 2.5rem 3rem;
    background: var(--mid);
    display: flex;
    gap: 2.5rem;
    align-items: flex-start;
  }

  .profile-avatar-wrap {
    position: relative;
    flex-shrink: 0;
  }

  .profile-avatar {
    width: 96px;
    height: 96px;
    border-radius: 50%;
    border: 3px solid var(--border);
    object-fit: cover;
  }

  .drop-zone {
    border: 1px dashed var(--border);
    padding: 1.5rem 1rem;
    text-align: center;
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
    line-height: 1.7;
    min-height: 90px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .drop-zone:hover, .drop-zone.drag-over {
    border-color: var(--accent2);
    color: var(--accent2);
    background: rgba(0,240,200,0.04);
  }

  .drop-zone.loaded {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(200,240,0,0.04);
  }

  .profile-bio {
    font-size: 0.88rem;
    color: #999;
    margin-top: 0.5rem;
    max-width: 480px;
    line-height: 1.6;
  }

  .comment-item {
    padding: 0.85rem 0;
    border-bottom: 1px solid var(--border);
  }

  .comment-item:last-child { border-bottom: none; }

  .comment-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.35rem;
  }

  .comment-avatar {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    object-fit: cover;
  }

  .comment-username {
    font-family: var(--mono);
    font-size: 0.68rem;
    color: var(--accent);
    cursor: pointer;
  }

  .comment-username:hover { text-decoration: underline; }

  .comment-time {
    font-family: var(--mono);
    font-size: 0.62rem;
    color: var(--muted);
    margin-left: auto;
  }

  .comment-text {
    font-size: 0.88rem;
    color: #ccc;
    line-height: 1.5;
    padding-left: 1.75rem;
  }

  .btn-follow {
    font-family: var(--mono);
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.5rem 1.4rem;
    border: 1px solid var(--accent);
    background: var(--accent);
    color: var(--black);
    cursor: pointer;
    transition: all 0.2s;
    font-weight: 500;
  }

  .btn-follow:hover { background: #d9ff00; }

  .btn-unfollow {
    font-family: var(--mono);
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.5rem 1.4rem;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-unfollow:hover { border-color: #ff6060; color: #ff6060; }

  .search-result-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }

  .search-result-item:last-child { border-bottom: none; }
  .search-result-item:hover { background: #1a1a1a; }

  .search-result-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    object-fit: cover;
  }

  .search-result-name {
    font-family: var(--mono);
    font-size: 0.75rem;
    color: var(--white);
  }

  .search-result-handle {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--muted);
  }

  .profile-info { flex: 1; }

  .profile-name {
    font-family: var(--display);
    font-size: 3rem;
    line-height: 1;
    margin-bottom: 0.25rem;
  }

  .profile-handle {
    font-family: var(--mono);
    font-size: 0.78rem;
    color: var(--muted);
    margin-bottom: 1.25rem;
  }

  .profile-stats {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
  }

  .profile-stat {
    text-align: center;
  }

  .profile-stat-val {
    font-family: var(--display);
    font-size: 1.8rem;
    color: var(--white);
    line-height: 1;
  }

  .profile-stat-label {
    font-family: var(--mono);
    font-size: 0.62rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-top: 0.2rem;
  }

  .profile-tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 2.5rem;
    background: var(--mid);
  }

  .profile-tab {
    font-family: var(--mono);
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 1rem 1.5rem;
    cursor: pointer;
    border: none;
    background: none;
    color: var(--muted);
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }

  .profile-tab.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  .profile-content {
    padding: 2.5rem;
  }

  .profile-section { display: none; }
  .profile-section.active { display: block; }

  /* ‚îÄ‚îÄ MAIN PAGE ‚îÄ‚îÄ */
  #main-page { display: block; }
  #main-page.hidden { display: none; }

  /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
  #hero {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    justify-content: center;
    padding: 8rem 2.5rem 4rem;
    position: relative;
    overflow: hidden;
  }

  .hero-grid {
    position: absolute;
    inset: 0;
    background-image:
      linear-gradient(rgba(200,240,0,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(200,240,0,0.04) 1px, transparent 1px);
    background-size: 60px 60px;
    mask-image: radial-gradient(ellipse 80% 60% at 50% 50%, black 0%, transparent 100%);
  }

  .hero-tag {
    font-family: var(--mono);
    font-size: 0.72rem;
    letter-spacing: 0.2em;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    animation: fadeUp 0.6s ease both;
  }

  .hero-tag::before {
    content: '';
    display: block;
    width: 2rem;
    height: 1px;
    background: var(--accent);
  }

  h1 {
    font-family: var(--display);
    font-size: clamp(5rem, 14vw, 13rem);
    line-height: 0.9;
    letter-spacing: 0.02em;
    color: var(--white);
    margin-bottom: 0.3em;
    animation: fadeUp 0.6s ease 0.1s both;
  }

  h1 span { color: var(--accent); display: block; }

  .hero-sub {
    font-size: 1.15rem;
    color: #aaa;
    max-width: 520px;
    margin: 1.5rem 0 3rem;
    font-weight: 300;
    line-height: 1.7;
    animation: fadeUp 0.6s ease 0.2s both;
  }

  .hero-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    animation: fadeUp 0.6s ease 0.3s both;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.85rem 1.8rem;
    font-family: var(--mono);
    font-size: 0.78rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-primary {
    background: var(--accent);
    color: var(--black);
    font-weight: 500;
  }

  .btn-primary:hover {
    background: #d9ff00;
    transform: translateY(-2px);
    box-shadow: 0 8px 30px rgba(200,240,0,0.3);
  }

  .btn-outline {
    background: transparent;
    color: var(--white);
    border: 1px solid var(--border);
  }

  .btn-outline:hover {
    border-color: var(--white);
    transform: translateY(-2px);
  }

  .hero-stats {
    display: flex;
    gap: 3rem;
    margin-top: 5rem;
    padding-top: 2rem;
    border-top: 1px solid var(--border);
    animation: fadeUp 0.6s ease 0.4s both;
  }

  .stat-label {
    font-family: var(--mono);
    font-size: 0.68rem;
    letter-spacing: 0.15em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 0.3rem;
  }

  .stat-val {
    font-family: var(--display);
    font-size: 2.2rem;
    color: var(--white);
    letter-spacing: 0.05em;
  }

  /* ‚îÄ‚îÄ HOW IT WORKS ‚îÄ‚îÄ */
  #how {
    padding: 7rem 2.5rem;
    border-top: 1px solid var(--border);
  }

  .section-label {
    font-family: var(--mono);
    font-size: 0.68rem;
    letter-spacing: 0.2em;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 1rem;
  }

  .section-title {
    font-family: var(--display);
    font-size: clamp(2.5rem, 6vw, 5rem);
    line-height: 0.95;
    margin-bottom: 4rem;
  }

  .steps {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0;
    border: 1px solid var(--border);
  }

  .step {
    padding: 2.5rem;
    border-right: 1px solid var(--border);
    position: relative;
  }

  .step:last-child { border-right: none; }

  .step-num {
    font-family: var(--display);
    font-size: 5rem;
    color: var(--border);
    line-height: 1;
    margin-bottom: 1.5rem;
  }

  .step-title {
    font-family: var(--mono);
    font-size: 0.85rem;
    letter-spacing: 0.1em;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 0.75rem;
  }

  .step p { font-size: 0.95rem; color: #999; line-height: 1.7; }

  /* ‚îÄ‚îÄ USE CASES ‚îÄ‚îÄ */
  #usecases {
    padding: 7rem 2.5rem;
    border-top: 1px solid var(--border);
    background: var(--mid);
  }

  .cases-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1px;
    background: var(--border);
    margin-top: 3rem;
  }

  .case {
    background: var(--mid);
    padding: 2.5rem;
    transition: background 0.2s;
  }

  .case:hover { background: #222; }
  .case-icon { font-size: 1.8rem; margin-bottom: 1rem; }

  .case h3 {
    font-family: var(--mono);
    font-size: 0.85rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--white);
    margin-bottom: 0.75rem;
  }

  .case p { font-size: 0.9rem; color: #888; line-height: 1.7; }

  /* ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
  #app {
    padding: 7rem 2.5rem;
    border-top: 1px solid var(--border);
  }

  .app-tabs {
    display: flex;
    gap: 0;
    border: 1px solid var(--border);
    width: fit-content;
    margin-bottom: 3rem;
  }

  .tab {
    padding: 0.75rem 1.8rem;
    font-family: var(--mono);
    font-size: 0.75rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    cursor: pointer;
    border: none;
    background: transparent;
    color: var(--muted);
    border-right: 1px solid var(--border);
    transition: all 0.2s;
  }

  .tab:last-child { border-right: none; }
  .tab.active { background: var(--accent); color: var(--black); font-weight: 500; }
  .tab:not(.active):hover { color: var(--white); background: #1a1a1a; }

  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  .app-card {
    border: 1px solid var(--border);
    padding: 2.5rem;
    max-width: 680px;
    background: var(--mid);
  }

  .field-label {
    font-family: var(--mono);
    font-size: 0.7rem;
    letter-spacing: 0.15em;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 0.5rem;
    display: block;
  }

  textarea, input[type="text"] {
    width: 100%;
    background: var(--black);
    border: 1px solid var(--border);
    color: var(--white);
    font-family: var(--mono);
    font-size: 0.88rem;
    padding: 1rem;
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
    line-height: 1.6;
  }

  textarea:focus, input[type="text"]:focus { border-color: var(--accent); }
  textarea { min-height: 120px; }
  .field-group { margin-bottom: 1.5rem; }

  /* Visibility toggle */
  .visibility-toggle {
    display: flex;
    gap: 0;
    border: 1px solid var(--border);
    width: fit-content;
    margin-top: 0.5rem;
  }

  .vis-btn {
    padding: 0.5rem 1.2rem;
    font-family: var(--mono);
    font-size: 0.68rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    border: none;
    background: transparent;
    color: var(--muted);
    border-right: 1px solid var(--border);
    transition: all 0.2s;
  }

  .vis-btn:last-child { border-right: none; }
  .vis-btn.active { background: var(--accent); color: var(--black); }

  .result-box {
    background: var(--black);
    border: 1px solid var(--accent);
    padding: 1.5rem;
    margin-top: 1.5rem;
    display: none;
  }

  .result-box.show { display: block; }

  .result-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 1rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--border);
  }

  .result-row:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

  .result-key {
    font-family: var(--mono);
    font-size: 0.68rem;
    letter-spacing: 0.12em;
    color: var(--muted);
    text-transform: uppercase;
    white-space: nowrap;
    flex-shrink: 0;
    padding-top: 2px;
  }

  .result-val {
    font-family: var(--mono);
    font-size: 0.78rem;
    color: var(--accent);
    word-break: break-all;
    text-align: right;
  }

  .copy-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: var(--mono);
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.3rem 0.6rem;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    flex-shrink: 0;
  }

  .copy-btn:hover { border-color: var(--accent); color: var(--accent); }

  .verify-result {
    padding: 1.5rem;
    margin-top: 1.5rem;
    font-family: var(--mono);
    font-size: 0.9rem;
    letter-spacing: 0.05em;
    display: none;
    align-items: center;
    gap: 1rem;
  }

  .verify-result.show { display: flex; }
  .verify-result.valid { background: rgba(0,240,200,0.08); border: 1px solid rgba(0,240,200,0.4); color: var(--accent2); }
  .verify-result.invalid { background: rgba(255,60,60,0.08); border: 1px solid rgba(255,60,60,0.4); color: #ff6060; }
  .verify-icon { font-size: 1.5rem; }

  /* ‚îÄ‚îÄ WALL ‚îÄ‚îÄ */
  #wall-panel .app-card { max-width: 100%; }

  .wall-empty {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--muted);
    font-family: var(--mono);
    font-size: 0.85rem;
  }

  .wall-grid { display: grid; gap: 1px; background: var(--border); }

  .wall-item {
    background: var(--mid);
    padding: 1.5rem;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 1rem;
    align-items: start;
  }

  .wall-item:hover { background: #222; }

  .wall-id {
    font-family: var(--mono);
    font-size: 0.68rem;
    letter-spacing: 0.1em;
    color: var(--muted);
    margin-bottom: 0.4rem;
  }

  .wall-user {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.4rem;
  }

  .wall-user-avatar {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    object-fit: cover;
  }

  .wall-user-name {
    font-family: var(--mono);
    font-size: 0.68rem;
    color: var(--accent);
    cursor: pointer;
  }

  .wall-user-name:hover { text-decoration: underline; }

  .wall-message { font-size: 0.95rem; color: var(--white); margin-bottom: 0.5rem; line-height: 1.5; }
  .wall-meta { font-family: var(--mono); font-size: 0.68rem; color: var(--muted); }

  .wall-badge {
    font-family: var(--mono);
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.3rem 0.7rem;
    border: 1px solid;
    white-space: nowrap;
  }

  .badge-revealed { border-color: var(--accent2); color: var(--accent2); }
  .badge-pending { border-color: var(--border); color: var(--muted); }

  /* ‚îÄ‚îÄ LOGIN GATE ‚îÄ‚îÄ */
  .login-gate {
    border: 1px solid var(--border);
    padding: 3rem;
    max-width: 480px;
    text-align: center;
    background: var(--mid);
  }

  .login-gate-icon { font-size: 2.5rem; margin-bottom: 1rem; }

  .login-gate h3 {
    font-family: var(--display);
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .login-gate p {
    font-family: var(--mono);
    font-size: 0.75rem;
    color: var(--muted);
    margin-bottom: 1.5rem;
    line-height: 1.6;
  }

  /* ‚îÄ‚îÄ SECURITY ‚îÄ‚îÄ */
  #security {
    padding: 7rem 2.5rem;
    border-top: 1px solid var(--border);
    background: var(--mid);
  }

  .security-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 4rem;
    margin-top: 3rem;
  }

  .sec-col h3 {
    font-family: var(--mono);
    font-size: 0.75rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
  }

  .sec-col h3.provides { color: var(--accent); }
  .sec-col h3.not-provides { color: #ff6060; }

  .sec-item {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: #999;
  }

  .sec-item::before { content: '‚úì'; color: var(--accent); font-family: var(--mono); flex-shrink: 0; }
  .sec-item.no::before { content: '‚úó'; color: #ff6060; }

  /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
  footer {
    padding: 3rem 2.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .footer-logo { font-family: var(--mono); font-size: 0.78rem; letter-spacing: 0.15em; color: var(--accent); }

  .footer-links { display: flex; gap: 2rem; list-style: none; }

  .footer-links a {
    font-family: var(--mono);
    font-size: 0.72rem;
    letter-spacing: 0.1em;
    color: var(--muted);
    text-decoration: none;
    text-transform: uppercase;
    transition: color 0.2s;
  }

  .footer-links a:hover { color: var(--white); }
  .footer-copy { font-family: var(--mono); font-size: 0.68rem; color: var(--muted); }

  /* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
  }

  .cursor {
    display: inline-block;
    width: 3px;
    height: 0.85em;
    background: var(--accent);
    margin-left: 4px;
    vertical-align: middle;
    animation: blink 1s step-end infinite;
  }

  /* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--black); }
  ::-webkit-scrollbar-thumb { background: var(--border); }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    nav { padding: 1rem 1.5rem; }
    .nav-links { display: none; }
    #hero { padding: 6rem 1.5rem 3rem; }
    .hero-stats { gap: 2rem; flex-wrap: wrap; }
    .steps { grid-template-columns: 1fr; }
    .step { border-right: none; border-bottom: 1px solid var(--border); }
    .cases-grid { grid-template-columns: 1fr; }
    .security-grid { grid-template-columns: 1fr; }
    #app, #how, #usecases, #security { padding: 4rem 1.5rem; }
    .app-card { padding: 1.5rem; }
    footer { flex-direction: column; align-items: flex-start; }
    .profile-header { flex-direction: column; padding: 2rem 1.5rem; }
    .profile-content { padding: 1.5rem; }
  }
</style>
</head>
<body>

<!-- AUTH MODAL -->
<div class="modal-overlay" id="auth-modal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-title">SIGN IN</div>
    <div class="modal-sub">One account. All your commitments.<br>Your key never leaves your device.</div>
    <button class="btn-google" onclick="signInWithGoogle()">
      <svg class="google-icon" viewBox="0 0 24 24">
        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
      </svg>
      Continue with Google
    </button>
    <div style="margin-top:1.5rem;font-family:var(--mono);font-size:0.65rem;color:var(--muted);text-align:center;line-height:1.7">
      By signing in you agree to our terms.<br>
      Your cryptographic keys never leave your browser.
    </div>
  </div>
</div>


<!-- USERNAME SETUP MODAL -->
<div class="modal-overlay" id="username-modal">
  <div class="modal">
    <div class="modal-title">PICK A USERNAME</div>
    <div class="modal-sub">This is your public handle on PSI-COMMIT.<br>You can change it later in your profile.</div>
    <div style="margin-bottom:1rem">
      <label class="field-label">Username</label>
      <div style="display:flex;gap:0.5rem;align-items:center">
        <span style="font-family:var(--mono);font-size:0.85rem;color:var(--muted)">@</span>
        <input type="text" id="username-input" placeholder="yourhandle" 
          style="flex:1" 
          oninput="validateUsername()"
          onkeydown="if(event.key==='Enter') submitUsername()">
      </div>
      <div style="font-family:var(--mono);font-size:0.65rem;margin-top:0.5rem" id="username-feedback"></div>
    </div>
    <button class="btn btn-primary" style="width:100%" onclick="submitUsername()" id="username-submit-btn">Set Username ‚Üí</button>
  </div>
</div>

<!-- EDIT PROFILE MODAL -->
<div class="modal-overlay" id="edit-profile-modal">
  <div class="modal" style="max-width:480px">
    <button class="modal-close" onclick="closeEditProfile()">‚úï</button>
    <div class="modal-title">EDIT PROFILE</div>
    <div class="modal-sub">Update your public profile.</div>
    <div class="field-group">
      <label class="field-label">Username</label>
      <div style="display:flex;gap:0.5rem;align-items:center">
        <span style="font-family:var(--mono);font-size:0.85rem;color:var(--muted)">@</span>
        <input type="text" id="edit-username" oninput="validateEditUsername()">
      </div>
      <div style="font-family:var(--mono);font-size:0.65rem;margin-top:0.4rem" id="edit-username-feedback"></div>
    </div>
    <div class="field-group">
      <label class="field-label">Display Name</label>
      <input type="text" id="edit-displayname" placeholder="Your full name">
    </div>
    <div class="field-group">
      <label class="field-label">Bio</label>
      <textarea id="edit-bio" placeholder="Tell people a bit about yourself..." style="min-height:80px"></textarea>
    </div>
    <div style="display:flex;gap:0.75rem;flex-wrap:wrap">
      <button class="btn btn-primary" onclick="saveProfile()" id="save-profile-btn">Save Changes ‚Üí</button>
      <button class="btn btn-outline" style="color:#ff6060;border-color:#ff6060" onclick="confirmDeleteAccount()">Delete Account</button>
    </div>
  </div>
</div>

<!-- COMMENTS MODAL -->
<div class="modal-overlay" id="comments-modal">
  <div class="modal" style="max-width:560px;max-height:80vh;overflow-y:auto">
    <button class="modal-close" onclick="document.getElementById('comments-modal').classList.remove('open')">‚úï</button>
    <div class="modal-title" style="font-size:1.4rem;margin-bottom:0.25rem">COMMENTS</div>
    <div style="font-family:var(--mono);font-size:0.68rem;color:var(--muted);margin-bottom:1.5rem" id="comments-commitment-id"></div>
    <div id="comments-list" style="margin-bottom:1.5rem"></div>
    <div id="comments-input-area">
      <textarea id="comment-input" placeholder="Add a comment..." style="min-height:70px;margin-bottom:0.75rem"></textarea>
      <button class="btn btn-primary" onclick="submitComment()" style="font-size:0.72rem;padding:0.65rem 1.4rem">Post Comment ‚Üí</button>
    </div>
    <div id="comments-login-prompt" style="display:none;font-family:var(--mono);font-size:0.75rem;color:var(--muted);text-align:center;padding:1rem">
      <a onclick="openModal()" style="color:var(--accent);cursor:pointer">Sign in</a> to comment.
    </div>
  </div>
</div>

<!-- NAV -->
<nav>
  <a class="nav-logo" href="#" onclick="showMainPage()">PSI ‚Äî COMMIT</a>
  <ul class="nav-links">
    <li><a href="#how">How it works</a></li>
    <li><a href="#app" onclick="showMainPage()">Commit</a></li>
    <li><a href="#app" onclick="showMainPage()">Wall</a></li>
    <li><a href="#verify-guide">Verify Guide</a></li>
    <li><a href="#security">Security</a></li>
    <li><a href="https://github.com/RayanOgh/psi-commit" target="_blank">GitHub</a></li>
  </ul>
  <div class="nav-auth">
    <!-- Shown when logged out -->
    <button class="btn-login" id="btn-login" onclick="openModal()">Sign In</button>
    <!-- Shown when logged in -->
    <div class="nav-user" id="nav-user" style="display:none" onclick="toggleDropdown()">
      <img class="nav-avatar" id="nav-avatar" src="" alt="avatar">
      <span class="nav-username" id="nav-username"></span>
      <div class="user-dropdown" id="user-dropdown">
        <a class="dropdown-item" onclick="showProfile()">My Profile</a>
        <a class="dropdown-item danger" onclick="signOut()">Sign Out</a>
      </div>
    </div>
  </div>
</nav>

<!-- PROFILE PAGE -->
<div id="profile-page">
  <div class="profile-header">
    <div class="profile-avatar-wrap">
      <img class="profile-avatar" id="profile-avatar" src="" alt="avatar">
    </div>
    <div class="profile-info">
      <div style="display:flex;align-items:flex-start;gap:1rem;flex-wrap:wrap;margin-bottom:0.5rem">
        <div>
          <div class="profile-name" id="profile-name">‚Äî</div>
          <div class="profile-handle" id="profile-handle">@‚Äî</div>
        <div class="profile-bio" id="profile-bio"></div>
        </div>
        <div id="profile-action-btns" style="margin-top:0.5rem"></div>
      </div>
      <div class="profile-stats">
        <div class="profile-stat">
          <div class="profile-stat-val" id="stat-public">0</div>
          <div class="profile-stat-label">Public Commits</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-val" id="stat-private" style="color:var(--muted)">0</div>
          <div class="profile-stat-label" style="color:#333">Private</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-val" id="stat-followers">0</div>
          <div class="profile-stat-label">Followers</div>
        </div>
        <div class="profile-stat">
          <div class="profile-stat-val" id="stat-following">0</div>
          <div class="profile-stat-label">Following</div>
        </div>
      </div>
    </div>
  </div>
  <div class="profile-tabs" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
    <div style="display:flex;flex-wrap:wrap">
      <button class="profile-tab active" onclick="switchProfileTab('public', this)">Public</button>
      <button class="profile-tab" onclick="switchProfileTab('private', this)">Private</button>
      <button class="profile-tab" id="tab-walls-btn" onclick="switchProfileTab('walls', this)" style="display:none">My Walls</button>
      <button class="profile-tab" id="tab-communities-btn" onclick="switchProfileTab('communities', this)" style="display:none">Communities</button>
    </div>
    <div id="edit-profile-btn-wrap" style="display:none;padding-right:1.5rem">
      <button class="btn-login" onclick="openEditProfile()" style="font-size:0.68rem;padding:0.4rem 1rem">Edit Profile</button>
    </div>
  </div>
  <div class="profile-content">
    <div class="profile-section active" id="tab-public">
      <div id="public-wall-container">
        <div class="wall-empty">No public commitments yet.</div>
      </div>
    </div>
    <div class="profile-section" id="tab-private">
      <div id="private-wall-container">
        <div class="wall-empty">No private commitments yet.</div>
      </div>
    </div>
    <div class="profile-section" id="tab-walls">
      <div style="padding:1.5rem 0">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
          <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent);letter-spacing:0.15em">PRIVATE WALLS</div>
          <button class="btn btn-outline" onclick="openCreateWall()" style="font-size:0.7rem;padding:0.5rem 1.2rem">+ Create Wall</button>
        </div>
        <div id="my-walls-container">
          <div class="wall-empty">No private walls joined yet.</div>
        </div>
      </div>
    </div>
    <div class="profile-section" id="tab-communities">
      <div style="padding:1.5rem 0">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
          <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent2);letter-spacing:0.15em">COMMUNITIES JOINED</div>
          <button class="btn btn-outline" onclick="showDirectory()" style="font-size:0.7rem;padding:0.5rem 1.2rem">Browse Directory ‚Üí</button>
        </div>
        <div id="my-communities-container">
          <div class="wall-empty">No communities joined yet.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MAIN PAGE -->
<div id="main-page">

<!-- HERO -->
<section id="hero">
  <div class="hero-grid"></div>
  <div class="hero-tag">Cryptographic Commitment Scheme</div>
  <h1>PROVE<span>YOU SAID<span class="cursor"></span></span>IT FIRST.</h1>
  <p class="hero-sub">Commit to any prediction, hypothesis, or decision before the outcome ‚Äî then reveal it later with mathematical proof you didn't cheat. No blockchain. No trust required.</p>
  <div class="hero-actions">
    <a href="#app" class="btn btn-primary">Make a Commitment ‚Üí</a>
    <a href="#how" class="btn btn-outline">How it works</a>
  </div>
  <div class="hero-stats">
    <div>
      <div class="stat-label">Algorithm</div>
      <div class="stat-val" style="font-size:1.1rem;font-family:var(--mono);color:var(--accent)">HMAC-SHA256</div>
    </div>
    <div>
      <div class="stat-label">Dependencies</div>
      <div class="stat-val">ZERO</div>
    </div>
    <div>
      <div class="stat-label">License</div>
      <div class="stat-val" style="font-size:1.1rem;font-family:var(--mono)">MIT</div>
    </div>
    <div>
      <div class="stat-label">Key Storage</div>
      <div class="stat-val" style="font-size:0.9rem;font-family:var(--mono);color:var(--accent2)">CLIENT ONLY</div>
    </div>
  </div>
</section>

<!-- HOW IT WORKS -->
<section id="how">
  <div class="section-label">Process</div>
  <h2 class="section-title">THREE STEPS.<br>ZERO TRUST.</h2>
  <div class="steps">
    <div class="step">
      <div class="step-num">01</div>
      <div class="step-title">Commit</div>
      <p>Write your prediction, hypothesis, or decision. A cryptographic digest is generated in your browser ‚Äî your secret key never leaves your device.</p>
    </div>
    <div class="step">
      <div class="step-num">02</div>
      <div class="step-title">Wait</div>
      <p>Publish your commitment ID publicly. It's completely unreadable ‚Äî nobody can guess your message from the hash, no matter how many tries.</p>
    </div>
    <div class="step">
      <div class="step-num">03</div>
      <div class="step-title">Reveal</div>
      <p>When you're ready, reveal your message and key. Anyone can verify ‚Äî mathematically ‚Äî that you wrote it before the outcome. The proof is permanent.</p>
    </div>
  </div>
</section>

<!-- USE CASES -->
<section id="usecases">
  <div class="section-label">Applications</div>
  <h2 class="section-title">WHO NEEDS<br>PROOF?</h2>
  <div class="cases-grid">
    <div class="case">
      <div class="case-icon">üî¨</div>
      <h3>Researchers</h3>
      <p>Pre-register hypotheses without going through a journal. Prove your analysis wasn't shaped by results. Block p-hacking and HARKing before they start.</p>
    </div>
    <div class="case">
      <div class="case-icon">üìà</div>
      <h3>Forecasters</h3>
      <p>Your Metaculus score is fine ‚Äî but can you prove what you called to people who weren't on the platform? Build a portable, verifiable prediction record.</p>
    </div>
    <div class="case">
      <div class="case-icon">üè¢</div>
      <h3>Executives & Teams</h3>
      <p>Seal strategic decisions before earnings calls, board meetings, or vendor negotiations. Cryptographic audit trail. No lawyers required.</p>
    </div>
    <div class="case">
      <div class="case-icon">üé≤</div>
      <h3>Fair Games</h3>
      <p>Simultaneous sealed-bid auctions, game moves, or contest submissions. Commit first, reveal together. Mathematically fair by design.</p>
    </div>
  </div>
</section>

<!-- APP -->
<section id="app">
  <div class="section-label">Tool</div>
  <h2 class="section-title" style="margin-bottom:2rem">USE IT NOW.</h2>

  <div class="app-tabs">
    <button class="tab active" onclick="switchTab('commit', event)">Commit</button>
    <button class="tab" onclick="switchTab('verify', event)">Verify</button>
    <button class="tab" onclick="switchTab('wall', event)">Wall</button>
  </div>

  <!-- COMMIT PANEL -->
  <div class="tab-panel active" id="commit-panel">
    <!-- Login gate (shown when logged out) -->
    <div class="login-gate" id="commit-login-gate">
      <div class="login-gate-icon">üîê</div>
      <h3>SIGN IN TO COMMIT</h3>
      <p>Create an account to seal your predictions and build a verifiable track record. Your cryptographic key never leaves your browser.</p>
      <button class="btn btn-primary" onclick="openModal()">Sign in with Google ‚Üí</button>
    </div>
    <!-- Commit form (shown when logged in) -->
    <div class="app-card" id="commit-form" style="display:none">
      <div class="field-group">
        <label class="field-label" for="commit-message">Your message / prediction / hypothesis</label>
        <textarea id="commit-message" placeholder="e.g. The Fed will cut rates by 25bps at the March 2026 meeting&#10;&#10;Be specific. Be honest. The commitment is only as meaningful as the claim."></textarea>
      </div>
      <div class="field-group">
        <label class="field-label" for="commit-context">Context label (optional)</label>
        <input type="text" id="commit-context" placeholder="e.g. macro-forecast, clinical-trial-2026, team-bet" value="default">
      </div>
      <div class="field-group">
        <label class="field-label">Visibility</label>
        <div class="visibility-toggle">
          <button class="vis-btn active" id="vis-public" onclick="setVisibility('public')">üåê Public</button>
          <button class="vis-btn" id="vis-private" onclick="setVisibility('private')">üîí Private</button>
        </div>
        <div style="font-family:var(--mono);font-size:0.65rem;color:var(--muted);margin-top:0.5rem" id="vis-desc">Public commitments appear on your profile and the wall.</div>
      </div>
      <button class="btn btn-primary" onclick="createCommitment()">Generate Commitment ‚Üí</button>

      <div class="result-box" id="commit-result">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem">
          <div style="font-family:var(--mono);font-size:0.68rem;letter-spacing:0.2em;color:var(--accent);text-transform:uppercase">Your Commitment Receipt</div>
          <div style="font-family:var(--mono);font-size:0.65rem;color:var(--muted)" id="res-time"></div>
        </div>
        <div id="commitment-card" style="background:var(--black);border:1px solid #333;padding:1.5rem;font-family:var(--mono);font-size:0.78rem;line-height:2;white-space:pre-wrap;word-break:break-all;color:#ccc"></div>
        <div style="background:rgba(200,240,0,0.06);border:1px solid rgba(200,240,0,0.25);padding:1rem 1.25rem;margin-top:1.25rem;font-family:var(--mono);font-size:0.72rem;color:var(--accent);line-height:1.7">
          ‚ö† SAVE THIS RECEIPT. Your secret key is not stored anywhere. If you lose it, you can never prove this commitment.
        </div>
        <div style="display:flex;gap:0.75rem;margin-top:1.25rem;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="downloadPSC()" style="font-size:0.72rem;padding:0.7rem 1.4rem">‚Üì Download Files (.psc + .stamp.txt)</button>
          <button class="btn btn-outline" onclick="exportOTS()" style="font-size:0.72rem;padding:0.7rem 1.4rem" id="export-ots-btn">‚Üì Export .ots File</button>
          <button class="btn btn-outline" onclick="copyCard()" style="font-size:0.72rem;padding:0.7rem 1.4rem">Copy Text</button>
          <button class="btn btn-outline" onclick="addToWall()" style="font-size:0.72rem;padding:0.7rem 1.4rem" id="add-wall-btn">+ Add to Wall</button>
        </div>
      </div>
    </div>
  </div>

  <!-- VERIFY PANEL -->
  <div class="tab-panel" id="verify-panel">

    <!-- SECTION 1: Verify commitment (message + receipt) -->
    <div class="app-card" style="margin-bottom:1.5rem">
      <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:1.25rem">Verify Commitment</div>
      <div class="field-group">
        <label class="field-label">Step 1 ‚Äî Paste your commitment receipt (.psc) or text receipt</label>
        <textarea id="verify-paste" placeholder="Paste your full commitment receipt here..." style="min-height:120px;font-size:0.78rem" oninput="parseReceipt()"></textarea>
        <div style="font-family:var(--mono);font-size:0.68rem;color:var(--muted);margin-top:0.5rem">Fields will fill automatically when you paste your receipt.</div>
      </div>
      <div id="parsed-fields" style="display:none">
        <div style="font-family:var(--mono);font-size:0.68rem;letter-spacing:0.15em;color:var(--accent);text-transform:uppercase;margin-bottom:1rem;padding-bottom:0.5rem;border-bottom:1px solid var(--border)">Parsed from receipt ‚úì</div>
        <div class="field-group">
          <label class="field-label">Commitment ID</label>
          <input type="text" id="p-id" readonly style="color:var(--accent);cursor:default;opacity:0.8">
        </div>
        <div class="field-group">
          <label class="field-label">Secret Key</label>
          <input type="text" id="p-key" readonly style="color:#ff9060;cursor:default;opacity:0.8">
        </div>
        <div class="field-group">
          <label class="field-label">MAC</label>
          <input type="text" id="p-mac" readonly style="cursor:default;opacity:0.8">
        </div>
        <div class="field-group">
          <label class="field-label">Nonce</label>
          <input type="text" id="p-nonce" readonly style="cursor:default;opacity:0.8">
        </div>
        <div class="field-group">
          <label class="field-label">Context</label>
          <input type="text" id="p-context" readonly style="cursor:default;opacity:0.8">
        </div>
      </div>
      <div class="field-group">
        <label class="field-label">Step 2 ‚Äî Enter the original message to verify</label>
        <textarea id="verify-message" placeholder="Type or paste the original message exactly as it was committed..." style="min-height:80px"></textarea>
      </div>
      <button class="btn btn-primary" onclick="verifyCommitment()">Verify Commitment ‚Üí</button>
      <div class="verify-result" id="verify-result">
        <span class="verify-icon" id="verify-icon"></span>
        <span id="verify-msg"></span>
      </div>
    </div>

    <!-- SECTION 2: Verify Bitcoin timestamp -->
    <div class="app-card">
      <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent2);letter-spacing:0.15em;text-transform:uppercase;margin-bottom:1.25rem">Verify Bitcoin Timestamp</div>
      <p style="font-size:0.85rem;color:#999;margin-bottom:1.5rem;line-height:1.7">Drop your <strong style="color:var(--white)">.ots</strong> and <strong style="color:var(--white)">.stamp.txt</strong> files to verify the Bitcoin timestamp independently ‚Äî no trust in us required.</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem">
        <div>
          <label class="field-label" style="margin-bottom:0.5rem;display:block">‚ë† Drop .ots file</label>
          <div id="ots-drop-zone" class="drop-zone" ondragover="event.preventDefault()" ondrop="handleOTSDrop(event)" onclick="document.getElementById('ots-file-input').click()">
            <div id="ots-drop-label">Drop .ots file here<br><span style="font-size:0.65rem;color:#555">or click to browse</span></div>
            <input type="file" id="ots-file-input" accept=".ots" style="display:none" onchange="handleOTSFile(this.files[0])">
          </div>
        </div>
        <div>
          <label class="field-label" style="margin-bottom:0.5rem;display:block">‚ë° Drop .stamp.txt file</label>
          <div id="stamp-drop-zone" class="drop-zone" ondragover="event.preventDefault()" ondrop="handleStampDrop(event)" onclick="document.getElementById('stamp-file-input').click()">
            <div id="stamp-drop-label">Drop .stamp.txt file here<br><span style="font-size:0.65rem;color:#555">or click to browse</span></div>
            <input type="file" id="stamp-file-input" accept=".txt" style="display:none" onchange="handleStampFile(this.files[0])">
          </div>
        </div>
      </div>

      <button class="btn btn-primary" onclick="verifyOTS()" id="verify-ots-btn" disabled style="opacity:0.4">Verify Bitcoin Timestamp ‚Üí</button>

      <div class="verify-result" id="ots-verify-result" style="display:none;margin-top:1rem">
        <span class="verify-icon" id="ots-verify-icon"></span>
        <span id="ots-verify-msg"></span>
      </div>

      <div style="margin-top:1.5rem;font-family:var(--mono);font-size:0.65rem;color:#444;line-height:1.8">
        You can also verify on <a href="https://dgi.io/ots/" target="_blank" style="color:var(--muted)">dgi.io/ots</a> or <a href="https://opentimestamps.org" target="_blank" style="color:var(--muted)">opentimestamps.org</a> ‚Äî drop .ots in box 1, .stamp.txt in box 2.
      </div>
    </div>
  </div>

  <!-- WALL PANEL -->
  <div class="tab-panel" id="wall-panel">
    <div style="margin-bottom:1.5rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
      <input type="text" id="user-search" placeholder="Search users by username..." 
        style="max-width:320px;padding:0.65rem 1rem;font-size:0.8rem"
        oninput="searchUsers(this.value)">
      <div id="search-results" style="display:none;position:absolute;background:#111;border:1px solid var(--border);min-width:280px;z-index:50;margin-top:2.5rem"></div>
    </div>
    <div class="app-card" style="max-width:100%;position:relative">
      <div id="wall-container">
        <div class="wall-empty" id="wall-empty">No public commitments yet.<br>
          <span style="color:#444;font-size:0.75rem;margin-top:0.5rem;display:block">Sign in and make a public commitment to appear here.</span>
        </div>
        <div class="wall-grid" id="wall-grid" style="display:none"></div>
      </div>
    </div>
  </div>
</section>

<!-- SECURITY -->
<section id="security">
  <div class="section-label">Trust Model</div>
  <h2 class="section-title">DON'T TRUST US.<br>VERIFY EVERYTHING.</h2>
  <div style="max-width:820px;margin:3rem auto 0">
    <div style="border:1px solid var(--accent);padding:2rem;margin-bottom:2rem;position:relative">
      <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent);letter-spacing:0.15em;margin-bottom:1rem">CORE GUARANTEE</div>
      <p style="font-size:1.15rem;line-height:1.8;color:var(--white)">We cannot forge your commitments. We cannot change your timestamps. We cannot lie about when you committed ‚Äî even if we wanted to. The math and Bitcoin make it impossible.</p>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:var(--border);margin-bottom:2rem">
      <div style="background:var(--black);padding:1.75rem">
        <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent2);letter-spacing:0.15em;margin-bottom:0.75rem">01 / YOUR KEY</div>
        <div style="font-family:var(--display);font-size:1.4rem;margin-bottom:0.75rem">NEVER LEAVES<br>YOUR DEVICE</div>
        <p style="font-size:0.82rem;color:#999;line-height:1.7">Your secret key is generated in your browser and never sent to our server. We store only the MAC ‚Äî a mathematical fingerprint. Without your key, the message is permanently hidden.</p>
      </div>
      <div style="background:var(--black);padding:1.75rem">
        <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent2);letter-spacing:0.15em;margin-bottom:0.75rem">02 / THE MATH</div>
        <div style="font-family:var(--display);font-size:1.4rem;margin-bottom:0.75rem">HMAC-SHA256<br>IS BINDING</div>
        <p style="font-size:0.82rem;color:#999;line-height:1.7">HMAC-SHA256 is a one-way function. Given a MAC, it is computationally impossible to find a different message that produces the same fingerprint.</p>
      </div>
      <div style="background:var(--black);padding:1.75rem">
        <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent2);letter-spacing:0.15em;margin-bottom:0.75rem">03 / BITCOIN</div>
        <div style="font-family:var(--display);font-size:1.4rem;margin-bottom:0.75rem">TIMESTAMP IS<br>PERMANENT</div>
        <p style="font-size:0.82rem;color:#999;line-height:1.7">Every commitment is anchored to the Bitcoin blockchain via OpenTimestamps. Nobody controls it ‚Äî not us, not you, not anyone.</p>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border)">
      <div style="background:var(--black);padding:1.75rem">
        <div style="font-family:var(--mono);font-size:0.65rem;color:#ff4444;letter-spacing:0.15em;margin-bottom:1rem">WHAT WE CANNOT DO</div>
        <ul style="font-size:0.82rem;color:#999;line-height:2.2;list-style:none">
          <li style="display:flex;gap:0.5rem"><span style="color:#ff4444">‚úó</span> Read your message before you reveal it</li>
          <li style="display:flex;gap:0.5rem"><span style="color:#ff4444">‚úó</span> Change what you committed to</li>
          <li style="display:flex;gap:0.5rem"><span style="color:#ff4444">‚úó</span> Backdate or alter your timestamp</li>
          <li style="display:flex;gap:0.5rem"><span style="color:#ff4444">‚úó</span> Forge a commitment on your behalf</li>
          <li style="display:flex;gap:0.5rem"><span style="color:#ff4444">‚úó</span> Prevent you from verifying independently</li>
        </ul>
      </div>
      <div style="background:var(--black);padding:1.75rem">
        <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent);letter-spacing:0.15em;margin-bottom:1rem">WHAT WE DO</div>
        <ul style="font-size:0.82rem;color:#999;line-height:2.2;list-style:none">
          <li style="display:flex;gap:0.5rem"><span style="color:var(--accent)">‚úì</span> Store your public MAC and timestamp</li>
          <li style="display:flex;gap:0.5rem"><span style="color:var(--accent)">‚úì</span> Submit your MAC to Bitcoin via OTS</li>
          <li style="display:flex;gap:0.5rem"><span style="color:var(--accent)">‚úì</span> Verify your key matches on reveal</li>
          <li style="display:flex;gap:0.5rem"><span style="color:var(--accent)">‚úì</span> Maintain the public wall</li>
          <li style="display:flex;gap:0.5rem"><span style="color:var(--accent)">‚úì</span> Keep the code open source forever</li>
        </ul>
      </div>
    </div>
  </div>
</section>

<!-- TRANSPARENCY -->
<section style="padding:7rem 2.5rem;border-top:1px solid var(--border)">
  <div class="section-label">Transparency</div>
  <h2 class="section-title">WHAT THIS<br>DOES & DOESN'T.</h2>
  <div class="security-grid">
    <div class="sec-col">
      <h3 class="provides">What this provides</h3>
      <div class="sec-item">Cryptographic binding ‚Äî you cannot change your message after committing</div>
      <div class="sec-item">Cryptographic hiding ‚Äî the commitment reveals nothing until you reveal</div>
      <div class="sec-item">Bitcoin timestamp ‚Äî every commitment is permanently anchored to the blockchain via OpenTimestamps</div>
      <div class="sec-item">Domain separation ‚Äî prevents cross-context replay attacks</div>
      <div class="sec-item">Constant-time verification ‚Äî immune to timing attacks</div>
      <div class="sec-item">Zero-knowledge server ‚Äî your secret never leaves your browser</div>
      <div class="sec-item">HMAC-SHA256 ‚Äî 256-bit security, same standard used by AWS and GitHub</div>
    </div>
    <div class="sec-col">
      <h3 class="not-provides">What this does NOT provide</h3>
      <div class="sec-item no">Anonymity ‚Äî your username is attached to public commitments</div>
      <div class="sec-item no">Forward secrecy ‚Äî if your key is compromised, that commitment can be forged</div>
      <div class="sec-item no">Legal enforceability ‚Äî cryptographic proof is not the same as legal proof</div>
      <div class="sec-item no">Message recovery ‚Äî if you lose your secret key, your commitment cannot be revealed</div>
    </div>
  </div>
  <div style="margin-top:3rem;padding:2rem;border:1px solid var(--border);max-width:680px">
    <div class="section-label" style="margin-bottom:0.5rem">Open Source</div>
    <p style="color:#999;font-size:0.9rem;line-height:1.7">The cryptographic core is MIT-licensed and publicly auditable. Don't trust us ‚Äî read the code.</p>
    <a href="https://github.com/RayanOgh/psi-commit" target="_blank" class="btn btn-outline" style="margin-top:1.5rem;display:inline-flex">View Source on GitHub ‚Üí</a>
  </div>
</section>

<!-- VERIFICATION GUIDE -->
<section id="verify-guide" style="padding:7rem 2.5rem;border-top:1px solid var(--border)">
  <div class="section-label">Independent Verification</div>
  <h2 class="section-title">VERIFY WITHOUT<br>TRUSTING US.</h2>
  <p style="max-width:680px;color:#999;font-size:0.95rem;line-height:1.8;margin:2rem 0 3rem">Your .ots file is a cryptographic proof anchored in Bitcoin. You can verify it independently on opentimestamps.org or using the open-source OTS client ‚Äî no account needed, no trust in us required.</p>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:2rem;max-width:900px">
    <div style="border:1px solid var(--border);padding:2rem">
      <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent);letter-spacing:0.15em;margin-bottom:1rem">METHOD 01 / WEBSITE</div>
      <div style="font-family:var(--display);font-size:1.6rem;margin-bottom:1rem">OPENTIMESTAMPS<br>.ORG</div>
      <ol style="font-size:0.85rem;color:#999;line-height:2.2;padding-left:1.2rem">
        <li>Go to your profile and click <strong style="color:var(--white)">‚Üì .ots</strong> on any commitment</li>
        <li>Name and save the file to your computer</li>
        <li>Visit <a href="https://opentimestamps.org" target="_blank" style="color:var(--accent)">opentimestamps.org</a></li>
        <li>Drag and drop your <strong style="color:var(--white)">.ots file</strong> onto the page</li>
        <li>It will show the Bitcoin block number and timestamp ‚Äî independent of us</li>
      </ol>
    </div>
    <div style="border:1px solid var(--border);padding:2rem">
      <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent2);letter-spacing:0.15em;margin-bottom:1rem">METHOD 02 / COMMAND LINE</div>
      <div style="font-family:var(--display);font-size:1.6rem;margin-bottom:1rem">OTS CLIENT<br>(ADVANCED)</div>
      <div style="font-size:0.85rem;color:#999;line-height:1.8;margin-bottom:1rem">For developers who want full local verification:</div>
      <div style="background:#111;padding:1rem;font-family:var(--mono);font-size:0.72rem;color:var(--accent2);line-height:2">
        pip install opentimestamps-client<br>
        ots verify yourfile.ots
      </div>
      <p style="font-size:0.78rem;color:#666;margin-top:1rem;line-height:1.6">The OTS client connects directly to Bitcoin nodes to verify the proof ‚Äî completely independent of psicommit.com.</p>
    </div>
  </div>

  <div style="margin-top:2rem;padding:1.5rem 2rem;border:1px solid var(--border);max-width:900px;display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
    <div style="font-family:var(--mono);font-size:0.72rem;color:var(--muted)">‚ö° Note: Bitcoin confirmation takes 1-2 hours after your commitment is made. Until confirmed, the .ots file is a pending receipt. Once confirmed, it is permanently anchored in the Bitcoin blockchain ‚Äî forever.</div>
  </div>
</section>

<!-- FOOTER -->
<footer>
  <div class="footer-logo">PSI ‚Äî COMMIT</div>
  <ul class="footer-links">
    <li><a href="#app" onclick="showMainPage()">Commit</a></li>
    <li><a href="#app" onclick="showMainPage()">Verify</a></li>
    <li><a href="#verify-guide">How to Verify</a></li>
    <li><a href="#verify-guide">Verify</a></li>
    <li><a href="#security">Security</a></li>
    <li><a href="https://github.com/RayanOgh/psi-commit" target="_blank">GitHub</a></li>
  </ul>
  <div class="footer-copy">MIT License ¬∑ HMAC-SHA256 ¬∑ Bitcoin-anchored via OpenTimestamps</div>
</footer>

<!-- CREATE WALL MODAL -->
<div class="modal-overlay" id="create-wall-modal" onclick="if(event.target===this)closeCreateWall()">
  <div class="modal" style="max-width:460px">
    <div class="modal-title">Create Private Wall</div>
    <div class="field-group">
      <label class="field-label">Wall Name</label>
      <input type="text" id="new-wall-name" placeholder="e.g. My Prediction Group" maxlength="60">
    </div>
    <div class="field-group">
      <label class="field-label">Description (optional)</label>
      <textarea id="new-wall-desc" placeholder="What is this wall for?" style="min-height:80px"></textarea>
    </div>
    <div style="display:flex;gap:0.75rem;margin-top:1.5rem">
      <button class="btn btn-primary" onclick="createPrivateWall()" style="flex:1">Create Wall ‚Üí</button>
      <button class="btn btn-outline" onclick="closeCreateWall()">Cancel</button>
    </div>
  </div>
</div>

<!-- WALL INVITE MODAL -->
<div class="modal-overlay" id="wall-invite-modal" onclick="if(event.target===this)closeWallInvite()">
  <div class="modal" style="max-width:460px">
    <div class="modal-title" id="wall-invite-title">Wall Created!</div>
    <p style="color:#999;font-size:0.85rem;margin-bottom:1.5rem">Share this invite link with people you want to add to your wall.</p>
    <div style="background:#111;border:1px solid var(--border);padding:1rem;font-family:var(--mono);font-size:0.72rem;word-break:break-all;color:var(--accent)" id="wall-invite-link"></div>
    <div style="display:flex;gap:0.75rem;margin-top:1rem">
      <button class="btn btn-primary" onclick="copyWallLink()" style="flex:1">Copy Link</button>
      <button class="btn btn-outline" onclick="closeWallInvite()">Done</button>
    </div>
  </div>
</div>

<!-- WALL VIEW PAGE -->
<div id="wall-page" style="display:none;padding:6rem 2.5rem 4rem;max-width:900px;margin:0 auto">
  <button onclick="backFromWall()" style="background:none;border:none;color:var(--muted);font-family:var(--mono);font-size:0.72rem;cursor:pointer;margin-bottom:2rem;padding:0">‚Üê Back</button>
  <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:2rem;flex-wrap:wrap;gap:1rem">
    <div>
      <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent);letter-spacing:0.15em;margin-bottom:0.5rem">PRIVATE WALL</div>
      <div style="font-family:var(--display);font-size:2.5rem" id="wall-page-name">‚Äî</div>
      <div style="color:#999;font-size:0.85rem;margin-top:0.5rem" id="wall-page-desc"></div>
    </div>
    <div style="display:flex;gap:0.75rem;flex-wrap:wrap" id="wall-page-actions"></div>
  </div>
  <div id="wall-page-members" style="margin-bottom:2rem"></div>
  <div id="wall-page-commitments">
    <div class="wall-empty">No commitments on this wall yet.</div>
  </div>
</div>

<!-- JOIN REQUEST PAGE -->
<div id="join-request-page" style="display:none;padding:6rem 2.5rem 4rem;max-width:600px;margin:0 auto;text-align:center">
  <div style="font-family:var(--display);font-size:3rem;margin-bottom:1rem">PRIVATE WALL</div>
  <p style="color:#999;margin-bottom:2rem">This wall is private. You need to be approved by the leader to join.</p>
  <div style="background:#111;border:1px solid var(--border);padding:1.5rem;margin-bottom:2rem;text-align:left">
    <div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent);margin-bottom:0.5rem">WALL</div>
    <div style="font-size:1.2rem;font-family:var(--display)" id="join-wall-name">‚Äî</div>
  </div>
  <button class="btn btn-primary" onclick="requestToJoinWall()" id="join-request-btn">Request to Join ‚Üí</button>
  <div id="join-request-result" style="margin-top:1rem;font-family:var(--mono);font-size:0.75rem;color:var(--accent)"></div>
</div>

</div><!-- end main-page -->

<script>
// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
const SUPABASE_URL = 'https://tdqlqemmlfcldhmtxziv.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRkcWxxZW1tbGZjbGRobXR4eml2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMzg0ODgsImV4cCI6MjA4NzgxNDQ4OH0.zDdr4uOIelx2CbNyMWmRaSN9TuNMA_eCBr2E98ElmWo';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: {
    persistSession: true,
    storageKey: 'psicommit-auth',
    storage: window.localStorage,
    autoRefreshToken: true,
    detectSessionInUrl: true,
  }
});

const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8000' : '';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let currentUser = null;
let currentProfile = null;
let currentCommitment = null;
let wallItems = [];
let commitVisibility = 'public';

// ‚îÄ‚îÄ AVATAR GENERATION ‚îÄ‚îÄ
// Generate a unique cartoon avatar URL using DiceBear API
function getAvatarUrl(seed) {
  return `https://api.dicebear.com/7.x/fun-emoji/svg?seed=${encodeURIComponent(seed)}&backgroundColor=0a0a0a`;
}

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
async function signInWithGoogle() {
  const { error } = await sb.auth.signInWithOAuth({
    provider: 'google',
    options: {
      redirectTo: window.location.origin
    }
  });
  if (error) alert('Sign in error: ' + error.message);
}

async function signOut() {
  await sb.auth.signOut();
  currentUser = null;
  currentProfile = null;
  updateAuthUI(null);
  showMainPage();
}

function openModal() {
  document.getElementById('auth-modal').classList.add('open');
}

function closeModal() {
  document.getElementById('auth-modal').classList.remove('open');
}

// Close modal on overlay click
document.getElementById('auth-modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

// ‚îÄ‚îÄ PROFILE CREATION ‚îÄ‚îÄ
async function ensureProfile(user) {
  // Check if profile exists
  const { data: existing } = await sb
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (existing) {
    currentProfile = existing;
    return existing;
  }

  // New user ‚Äî show username picker modal
  document.getElementById('username-modal').classList.add('open');
  // Pre-fill with a suggestion
  const name = user.user_metadata?.full_name || user.email?.split('@')[0] || 'user';
  const suggested = name.toLowerCase().replace(/[^a-z0-9]/g, '');
  document.getElementById('username-input').value = suggested;
  validateUsername();
  return null; // profile will be created after username is chosen
}

async function submitUsername() {
  const user = currentUser;
  if (!user) return;

  const username = document.getElementById('username-input').value.trim().toLowerCase();
  if (!isValidUsername(username)) return;

  const btn = document.getElementById('username-submit-btn');
  btn.textContent = 'Checking...';
  btn.disabled = true;

  // Check uniqueness
  const { data: taken } = await sb
    .from('profiles')
    .select('id')
    .eq('username', username)
    .single();

  if (taken) {
    document.getElementById('username-feedback').textContent = 'Username taken ‚Äî try another.';
    document.getElementById('username-feedback').style.color = '#ff6060';
    btn.textContent = 'Set Username ‚Üí';
    btn.disabled = false;
    return;
  }

  // Create profile
  const name = user.user_metadata?.full_name || username;
  const avatarUrl = user.user_metadata?.avatar_url || getAvatarUrl(user.id);

  const { data: profile, error } = await sb
    .from('profiles')
    .insert({
      id: user.id,
      username,
      full_name: name,
      avatar_url: avatarUrl,
      avatar_seed: user.id,
    })
    .select()
    .single();

  if (error) {
    console.error('Profile creation error:', error);
    document.getElementById('username-feedback').textContent = 'Error creating profile. Try again.';
    document.getElementById('username-feedback').style.color = '#ff6060';
    btn.textContent = 'Set Username ‚Üí';
    btn.disabled = false;
    return;
  }

  currentProfile = profile;
  document.getElementById('username-modal').classList.remove('open');
  updateAuthUI(user);
}

function isValidUsername(u) {
  return u.length >= 3 && u.length <= 20 && /^[a-z0-9_]+$/.test(u);
}

function validateUsername() {
  const u = document.getElementById('username-input').value.trim().toLowerCase();
  const feedback = document.getElementById('username-feedback');
  if (!u) { feedback.textContent = ''; return; }
  if (u.length < 3) {
    feedback.textContent = 'At least 3 characters.';
    feedback.style.color = '#ff6060';
  } else if (u.length > 20) {
    feedback.textContent = 'Max 20 characters.';
    feedback.style.color = '#ff6060';
  } else if (!/^[a-z0-9_]+$/.test(u)) {
    feedback.textContent = 'Only letters, numbers, and underscores.';
    feedback.style.color = '#ff6060';
  } else {
    feedback.textContent = '‚úì Looks good';
    feedback.style.color = 'var(--accent)';
  }
}

// ‚îÄ‚îÄ UPDATE UI AFTER AUTH ‚îÄ‚îÄ
function updateAuthUI(user) {
  const btnLogin = document.getElementById('btn-login');
  const navUser = document.getElementById('nav-user');
  const commitLoginGate = document.getElementById('commit-login-gate');
  const commitForm = document.getElementById('commit-form');

  if (user && currentProfile) {
    btnLogin.style.display = 'none';
    navUser.style.display = 'flex';

    const avatarUrl = currentProfile.avatar_url || getAvatarUrl(currentProfile.avatar_seed || user.id);
    document.getElementById('nav-avatar').src = avatarUrl;
    document.getElementById('nav-username').textContent = '@' + currentProfile.username;

    // Show commit form
    if (commitLoginGate) commitLoginGate.style.display = 'none';
    if (commitForm) commitForm.style.display = 'block';

    closeModal();
  } else {
    btnLogin.style.display = 'block';
    navUser.style.display = 'none';

    // Show login gate
    if (commitLoginGate) commitLoginGate.style.display = 'block';
    if (commitForm) commitForm.style.display = 'none';
  }
}

// ‚îÄ‚îÄ DROPDOWN ‚îÄ‚îÄ
function toggleDropdown() {
  document.getElementById('user-dropdown').classList.toggle('open');
}

document.addEventListener('click', function(e) {
  if (!document.getElementById('nav-user').contains(e.target)) {
    document.getElementById('user-dropdown').classList.remove('open');
  }
});

// ‚îÄ‚îÄ PAGE NAVIGATION ‚îÄ‚îÄ
function showMainPage() {
  document.getElementById('main-page').classList.remove('hidden');
  document.getElementById('profile-page').classList.remove('active');
}

// viewingUserId = null means own profile
let viewingUserId = null;

async function showProfile(userId = null) {
  document.getElementById('user-dropdown').classList.remove('open');
  document.getElementById('main-page').classList.add('hidden');
  document.getElementById('profile-page').classList.add('active');
  window.scrollTo(0, 0);
  viewingUserId = userId;
  await loadProfileData(userId);
}

// ‚îÄ‚îÄ LOAD PROFILE DATA ‚îÄ‚îÄ
async function loadProfileData(userId = null) {
  const targetId = userId || currentUser?.id;
  if (!targetId) return;

  // Fetch profile
  const { data: profile } = await sb
    .from('profiles')
    .select('*')
    .eq('id', targetId)
    .single();

  if (!profile) return;

  const isOwnProfile = !userId || userId === currentUser?.id;

  // Show/hide private tab
  document.querySelector('[onclick*="private"]').style.display = isOwnProfile ? 'block' : 'none';

  const avatarUrl = profile.avatar_url || getAvatarUrl(profile.avatar_seed || targetId);
  document.getElementById('profile-avatar').src = avatarUrl;
  document.getElementById('profile-name').textContent = profile.full_name || profile.username;
  document.getElementById('profile-handle').textContent = '@' + profile.username;
  document.getElementById('stat-followers').textContent = profile.followers_count || 0;
  document.getElementById('stat-following').textContent = profile.following_count || 0;

  // Show bio if exists
  const bioEl = document.getElementById('profile-bio');
  if (bioEl) bioEl.textContent = profile.bio || '';

  // Show/hide edit button
  const editWrap = document.getElementById('edit-profile-btn-wrap');
  if (editWrap) editWrap.style.display = isOwnProfile ? 'block' : 'none';

  // Show My Walls and Communities tabs only on own profile
  const wallsBtn = document.getElementById('tab-walls-btn');
  const commBtn = document.getElementById('tab-communities-btn');
  if (wallsBtn) wallsBtn.style.display = isOwnProfile ? 'inline-flex' : 'none';
  if (commBtn) commBtn.style.display = isOwnProfile ? 'inline-flex' : 'none';

  if (isOwnProfile) {
    loadMyWalls();
    loadMyCommunities();
  }

  // Show follow/unfollow button or nothing for own profile
  const actionBtns = document.getElementById('profile-action-btns');
  if (!isOwnProfile && currentUser) {
    // Check if already following
    const { data: followRow } = await sb
      .from('follows')
      .select('follower_id')
      .eq('follower_id', currentUser.id)
      .eq('following_id', targetId)
      .single();

    const isFollowing = !!followRow;
    actionBtns.innerHTML = isFollowing
      ? `<button class="btn-unfollow" onclick="unfollowUser('${targetId}')">Following</button>`
      : `<button class="btn-follow" onclick="followUser('${targetId}')">+ Follow</button>`;
  } else {
    actionBtns.innerHTML = '';
  }

  // Load public commitments
  const { data: publicCommits } = await sb
    .from('commitments')
    .select('*')
    .eq('user_id', targetId)
    .eq('visibility', 'public')
    .order('committed_at', { ascending: false });

  document.getElementById('stat-public').textContent = publicCommits?.length || 0;
  renderProfileCommits('public-wall-container', publicCommits || []);

  if (isOwnProfile) {
    const { data: privateCommits } = await sb
      .from('commitments')
      .select('*')
      .eq('user_id', targetId)
      .eq('visibility', 'private')
      .order('committed_at', { ascending: false });

    document.getElementById('stat-private').textContent = privateCommits?.length || 0;
    renderProfileCommits('private-wall-container', privateCommits || [], true);

    // Update public count in DB
    await sb.from('profiles').update({ public_commits_count: publicCommits?.length || 0 }).eq('id', targetId);
  }
}

// ‚îÄ‚îÄ PRIVATE WALLS ‚îÄ‚îÄ
let currentWallId = null;
let currentWallInviteCode = null;

function openCreateWall() {
  if (!currentUser) { openModal(); return; }
  document.getElementById('create-wall-modal').classList.add('open');
}

function closeCreateWall() {
  document.getElementById('create-wall-modal').classList.remove('open');
  document.getElementById('new-wall-name').value = '';
  document.getElementById('new-wall-desc').value = '';
}

function closeWallInvite() {
  document.getElementById('wall-invite-modal').classList.remove('open');
}

async function createPrivateWall() {
  const name = document.getElementById('new-wall-name').value.trim();
  if (!name) {
    document.getElementById('new-wall-name').style.borderColor = '#ff6060';
    return;
  }
  const desc = document.getElementById('new-wall-desc').value.trim();

  const { data, error } = await sb.from('private_walls').insert({
    name,
    description: desc || null,
    creator_id: currentUser.id
  }).select().single();

  if (error) { alert('Error creating wall: ' + error.message); return; }

  closeCreateWall();
  
  // Show invite link
  const link = `${window.location.origin}/wall/${data.invite_code}`;
  document.getElementById('wall-invite-title').textContent = `"${data.name}" Created!`;
  document.getElementById('wall-invite-link').textContent = link;
  document.getElementById('wall-invite-modal').classList.add('open');
  currentWallInviteCode = data.invite_code;

  // Reload walls tab
  await loadMyWalls();
}

function copyWallLink() {
  const link = document.getElementById('wall-invite-link').textContent;
  navigator.clipboard.writeText(link).then(() => {
    const btn = event.target;
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = 'Copy Link', 2000);
  });
}

async function loadMyWalls() {
  const container = document.getElementById('my-walls-container');
  if (!container || !currentUser) return;

  try {
  // Get walls I created
  const { data: created, error: e1 } = await sb.from('private_walls')
    .select('*')
    .eq('creator_id', currentUser.id)
    .order('created_at', { ascending: false });

  if (e1) { console.warn('[Walls] Error loading created walls:', e1.message); }

  // Get walls I'm an approved member of
  const { data: memberships, error: e2 } = await sb.from('wall_members')
    .select('wall_id, status')
    .eq('user_id', currentUser.id)
    .eq('status', 'approved');

  if (e2) { console.warn('[Walls] Error loading memberships:', e2.message); }

  let memberWalls = [];
  if (memberships?.length) {
    const wallIds = memberships.map(m => m.wall_id);
    const { data: mwalls } = await sb.from('private_walls')
      .select('*')
      .in('id', wallIds);
    memberWalls = mwalls || [];
  }

  // Get pending requests
  const { data: pending, error: e3 } = await sb.from('wall_members')
    .select('wall_id')
    .eq('user_id', currentUser.id)
    .eq('status', 'pending');

  if (e3) { console.warn('[Walls] Error loading pending:', e3.message); }

  const allWalls = [
    ...(created || []).map(w => ({ ...w, role: 'leader' })),
    ...memberWalls.filter(w => !created?.find(c => c.id === w.id)).map(w => ({ ...w, role: 'member' }))
  ];

  if (!allWalls.length && !pending?.length) {
    container.innerHTML = '<div class="wall-empty">No private walls yet. Create one or ask someone for an invite link.</div>';
    return;
  }

  let html = '<div style="display:flex;flex-direction:column;gap:1rem">';

  if (pending?.length) {
    html += `<div style="font-family:var(--mono);font-size:0.65rem;color:var(--muted);margin-bottom:0.5rem">${pending.length} pending request(s)</div>`;
  }

  for (const wall of allWalls) {
    const isLeader = wall.role === 'leader';
    const link = `${window.location.origin}/wall/${wall.invite_code}`;
    html += `
    <div style="border:1px solid var(--border);padding:1.25rem;display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap">
      <div>
        <div style="font-family:var(--display);font-size:1.3rem;margin-bottom:0.25rem">${wall.name}</div>
        ${wall.description ? `<div style="color:#999;font-size:0.82rem">${wall.description}</div>` : ''}
        <div style="font-family:var(--mono);font-size:0.62rem;color:${isLeader ? 'var(--accent)' : 'var(--accent2)'};margin-top:0.5rem">${isLeader ? '‚òÖ LEADER' : 'MEMBER'}</div>
      </div>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
        <button class="btn btn-outline" onclick="openWallPage('${wall.id}')" style="font-size:0.68rem;padding:0.4rem 0.9rem">View Wall</button>
        ${isLeader ? `<button class="btn btn-outline" onclick="copyToClipboard('${link}')" style="font-size:0.68rem;padding:0.4rem 0.9rem;color:var(--accent2)">Share Link</button>` : ''}
        ${isLeader ? `<button class="btn btn-outline" onclick="manageWallMembers('${wall.id}')" style="font-size:0.68rem;padding:0.4rem 0.9rem">Manage Members</button>` : ''}
      </div>
    </div>`;
  }
  html += '</div>';
  container.innerHTML = html;
  } catch(e) {
    console.warn('[Walls] loadMyWalls failed:', e);
    container.innerHTML = '<div class="wall-empty">Could not load walls. Please try again.</div>';
  }
}

async function openWallPage(wallId) {
  currentWallId = wallId;

  // Hide all pages, show wall page
  document.getElementById('profile-page').classList.remove('active');
  document.getElementById('main-page').classList.add('hidden');
  document.getElementById('wall-page').style.display = 'block';
  window.scrollTo(0, 0);

  const { data: wall } = await sb.from('private_walls').select('*').eq('id', wallId).single();
  if (!wall) { alert('Wall not found.'); return; }

  document.getElementById('wall-page-name').textContent = wall.name;
  document.getElementById('wall-page-desc').textContent = wall.description || '';

  const isLeader = wall.creator_id === currentUser?.id;

  // Actions
  const actionsEl = document.getElementById('wall-page-actions');
  if (isLeader) {
    const link = `${window.location.origin}/wall/${wall.invite_code}`;
    actionsEl.innerHTML = `
      <button class="btn btn-outline" onclick="copyToClipboard('${link}')" style="font-size:0.72rem">Share Invite Link</button>
      <button class="btn btn-outline" onclick="manageWallMembers('${wallId}')" style="font-size:0.72rem">Manage Members</button>
      <button class="btn btn-primary" onclick="addCommitmentToWall('${wallId}')" style="font-size:0.72rem">+ Add Commitment</button>`;
  } else {
    actionsEl.innerHTML = `
      <button class="btn btn-primary" onclick="addCommitmentToWall('${wallId}')" style="font-size:0.72rem">+ Add Commitment</button>`;
  }

  // Load members
  const { data: members } = await sb.from('wall_members')
    .select('user_id, status, profiles(username, avatar_url, avatar_seed)')
    .eq('wall_id', wallId)
    .eq('status', 'approved');

  const membersEl = document.getElementById('wall-page-members');
  if (members?.length) {
    membersEl.innerHTML = `
      <div style="font-family:var(--mono);font-size:0.62rem;color:var(--muted);margin-bottom:0.75rem">MEMBERS (${members.length})</div>
      <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
        ${members.map(m => `
          <div style="display:flex;align-items:center;gap:0.4rem;background:#111;padding:0.3rem 0.6rem;border:1px solid var(--border)">
            <img src="${m.profiles?.avatar_url || getAvatarUrl(m.profiles?.avatar_seed || m.user_id)}" style="width:20px;height:20px;border-radius:50%">
            <span style="font-size:0.72rem">@${m.profiles?.username || '‚Äî'}</span>
          </div>`).join('')}
      </div>`;
  } else {
    membersEl.innerHTML = '';
  }

  // Load commitments
  const { data: wallCommits } = await sb.from('wall_commitments')
    .select('commitment_id, commitments(*)')
    .eq('wall_id', wallId)
    .order('added_at', { ascending: false });

  const commitsEl = document.getElementById('wall-page-commitments');
  if (wallCommits?.length) {
    const items = wallCommits.map(wc => wc.commitments).filter(Boolean);
    commitsEl.innerHTML = `<div class="wall-grid">${items.map(c => buildWallItem(c, isLeader || currentUser?.id === c.user_id)).join('')}</div>`;
  } else {
    commitsEl.innerHTML = '<div class="wall-empty">No commitments on this wall yet.</div>';
  }
}

function backFromWall() {
  document.getElementById('wall-page').style.display = 'none';
  document.getElementById('main-page').classList.remove('hidden');
  showProfile(viewingUserId);
}

async function manageWallMembers(wallId) {
  const { data: pending } = await sb.from('wall_members')
    .select('user_id, status, profiles(username)')
    .eq('wall_id', wallId)
    .eq('status', 'pending');

  if (!pending?.length) {
    alert('No pending join requests.');
    return;
  }

  // Simple approval UI using confirm dialogs for now
  for (const req of pending) {
    const username = req.profiles?.username || req.user_id;
    const approve = confirm(`Approve @${username} to join this wall?`);
    if (approve) {
      await sb.from('wall_members')
        .update({ status: 'approved' })
        .eq('wall_id', wallId)
        .eq('user_id', req.user_id);
    } else {
      await sb.from('wall_members')
        .delete()
        .eq('wall_id', wallId)
        .eq('user_id', req.user_id);
    }
  }
  alert('Done! Reload to see updated members.');
}

async function addCommitmentToWall(wallId) {
  // Show user's commitments to pick from
  const { data: commits } = await sb.from('commitments')
    .select('id, mac, committed_at, revealed, revealed_message')
    .eq('user_id', currentUser.id)
    .order('committed_at', { ascending: false });

  if (!commits?.length) { alert('You have no commitments to add.'); return; }

  const options = commits.map((c, i) => `${i + 1}. ${c.revealed ? c.revealed_message : c.id} (${new Date(c.committed_at).toLocaleDateString()})`).join('\n');
  const choice = prompt(`Choose a commitment to add (enter number):\n\n${options}`);
  if (!choice) return;

  const idx = parseInt(choice) - 1;
  if (isNaN(idx) || idx < 0 || idx >= commits.length) { alert('Invalid choice.'); return; }

  const commit = commits[idx];
  const { error } = await sb.from('wall_commitments').insert({
    wall_id: wallId,
    commitment_id: commit.id
  });

  if (error) {
    if (error.code === '23505') alert('This commitment is already on this wall.');
    else alert('Error: ' + error.message);
    return;
  }

  alert('Commitment added to wall!');
  await openWallPage(wallId);
}

// Handle invite link ‚Äî check if URL has /wall/{code}
async function handleWallInviteLink() {
  const path = window.location.pathname;
  const match = path.match(/^\/wall\/([a-zA-Z0-9]+)$/);
  if (!match) return false;

  const inviteCode = match[1];
  const { data: wall } = await sb.from('private_walls')
    .select('*')
    .eq('invite_code', inviteCode)
    .single();

  if (!wall) {
    // Show 404-like message
    document.getElementById('main-page').classList.add('hidden');
    document.getElementById('join-request-page').style.display = 'block';
    document.getElementById('join-wall-name').textContent = 'Wall not found.';
    document.getElementById('join-request-btn').style.display = 'none';
    return true;
  }

  // Check if user is already a member or leader
  if (currentUser) {
    if (wall.creator_id === currentUser.id) {
      await openWallPage(wall.id);
      return true;
    }
    const { data: membership } = await sb.from('wall_members')
      .select('status')
      .eq('wall_id', wall.id)
      .eq('user_id', currentUser.id)
      .single();

    if (membership?.status === 'approved') {
      await openWallPage(wall.id);
      return true;
    }

    if (membership?.status === 'pending') {
      document.getElementById('main-page').classList.add('hidden');
      document.getElementById('join-request-page').style.display = 'block';
      document.getElementById('join-wall-name').textContent = wall.name;
      document.getElementById('join-request-btn').textContent = 'Request Already Sent';
      document.getElementById('join-request-btn').disabled = true;
      document.getElementById('join-request-page').dataset.wallId = wall.id;
      return true;
    }
  }

  // Show join request page
  document.getElementById('main-page').classList.add('hidden');
  document.getElementById('join-request-page').style.display = 'block';
  document.getElementById('join-wall-name').textContent = wall.name;
  document.getElementById('join-request-page').dataset.wallId = wall.id;
  return true;
}

async function requestToJoinWall() {
  if (!currentUser) { openModal(); return; }
  const wallId = document.getElementById('join-request-page').dataset.wallId;
  if (!wallId) return;

  const { error } = await sb.from('wall_members').insert({
    wall_id: wallId,
    user_id: currentUser.id,
    status: 'pending'
  });

  const resultEl = document.getElementById('join-request-result');
  if (error) {
    resultEl.textContent = error.code === '23505' ? 'Request already sent.' : 'Error: ' + error.message;
  } else {
    document.getElementById('join-request-btn').disabled = true;
    document.getElementById('join-request-btn').textContent = 'Request Sent';
    resultEl.textContent = 'Your request has been sent. The wall leader will approve or deny it.';
  }
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    const orig = btn.textContent;
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = orig, 2000);
  });
}

// ‚îÄ‚îÄ FOLLOW / UNFOLLOW ‚îÄ‚îÄ
async function followUser(targetId) {
  if (!currentUser) { openModal(); return; }

  await sb.from('follows').insert({ follower_id: currentUser.id, following_id: targetId });

  // Increment counts
  await sb.rpc('increment_followers', { target_id: targetId });
  await sb.rpc('increment_following', { target_id: currentUser.id });

  // Reload profile to show updated counts + button
  await loadProfileData(targetId);
}

async function unfollowUser(targetId) {
  if (!currentUser) return;

  await sb.from('follows').delete()
    .eq('follower_id', currentUser.id)
    .eq('following_id', targetId);

  // Decrement counts
  await sb.rpc('decrement_followers', { target_id: targetId });
  await sb.rpc('decrement_following', { target_id: currentUser.id });

  await loadProfileData(targetId);
}

function renderProfileCommits(containerId, commits, isPrivate = false) {
  const container = document.getElementById(containerId);
  if (!commits.length) {
    container.innerHTML = `<div class="wall-empty">No ${isPrivate ? 'private' : 'public'} commitments yet.</div>`;
    return;
  }

  container.innerHTML = `<div class="wall-grid">${commits.map(item => buildWallItem(item, true)).join('')}</div>`;
}

// ‚îÄ‚îÄ SWITCH PROFILE TAB ‚îÄ‚îÄ
function switchProfileTab(name, el) {
  document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.profile-section').forEach(s => s.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tab-' + name).classList.add('active');
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function switchTab(name, event) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(name + '-panel').classList.add('active');
  if (event) event.target.classList.add('active');
  if (name === 'wall') renderWall();
}

// ‚îÄ‚îÄ VISIBILITY ‚îÄ‚îÄ
function setVisibility(v) {
  commitVisibility = v;
  document.getElementById('vis-public').classList.toggle('active', v === 'public');
  document.getElementById('vis-private').classList.toggle('active', v === 'private');
  document.getElementById('vis-desc').textContent = v === 'public'
    ? 'Public commitments appear on your profile and the wall.'
    : 'Private commitments are only visible to you on your profile.';
  const wallBtn = document.getElementById('add-wall-btn');
  if (wallBtn) wallBtn.style.display = v === 'public' ? 'inline-flex' : 'none';
}

// ‚îÄ‚îÄ CRYPTO ‚îÄ‚îÄ
function bytesToHex(bytes) {
  return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
}

function hexToBytes(hex) {
  const arr = new Uint8Array(hex.length / 2);
  for (let i = 0; i < hex.length; i += 2)
    arr[i / 2] = parseInt(hex.substr(i, 2), 16);
  return arr;
}

function generateRandomHex(bytes) {
  const arr = new Uint8Array(bytes);
  crypto.getRandomValues(arr);
  return bytesToHex(arr);
}

async function computeHMAC(keyHex, domain, nonce, message) {
  const keyBytes = hexToBytes(keyHex);
  const cryptoKey = await crypto.subtle.importKey(
    'raw', keyBytes, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
  );
  const enc = new TextEncoder();
  const domainBytes = enc.encode(domain);
  const nonceBytes = hexToBytes(nonce);
  const msgBytes = enc.encode(message);
  const combined = new Uint8Array(domainBytes.length + nonceBytes.length + msgBytes.length);
  combined.set(domainBytes, 0);
  combined.set(nonceBytes, domainBytes.length);
  combined.set(msgBytes, domainBytes.length + nonceBytes.length);
  const signature = await crypto.subtle.sign('HMAC', cryptoKey, combined);
  return bytesToHex(new Uint8Array(signature));
}

// ‚îÄ‚îÄ COMMIT ‚îÄ‚îÄ
async function createCommitment() {
  if (!currentUser) { openModal(); return; }

  const message = document.getElementById('commit-message').value.trim();
  const context = document.getElementById('commit-context').value.trim() || 'default';

  if (!message) {
    document.getElementById('commit-message').style.borderColor = '#ff6060';
    setTimeout(() => document.getElementById('commit-message').style.borderColor = '', 1500);
    return;
  }

  const key = generateRandomHex(32);
  const nonce = generateRandomHex(32);
  const domain = `psi-commit.v1.${context}`;
  const mac = await computeHMAC(key, domain, nonce, message);
  const id = 'psc_' + mac.substring(0, 16);
  const timestamp = new Date().toISOString();

  currentCommitment = { id, key, nonce, mac, domain, context, message, timestamp, visibility: commitVisibility };

  const card = [
    `PSI-COMMIT RECEIPT`,
    `${'‚îÄ'.repeat(48)}`,
    `ID        ${id}`,
    `DATE      ${new Date(timestamp).toLocaleString('en-US', { dateStyle: 'long', timeStyle: 'short' })}`,
    `CONTEXT   ${domain}`,
    `VISIBILITY ${commitVisibility.toUpperCase()}`,
    `${'‚îÄ'.repeat(48)}`,
    `MAC       ${mac}`,
    `NONCE     ${nonce}`,
    `${'‚îÄ'.repeat(48)}`,
    `SECRET KEY (keep private ‚Äî do not share until reveal)`,
    `${key}`,
    `${'‚îÄ'.repeat(48)}`,
    `Verify at: psicommit.com`,
  ].join('\n');

  document.getElementById('commitment-card').textContent = card;
  document.getElementById('res-time').textContent = new Date(timestamp).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  document.getElementById('commit-result').classList.add('show');

  // Update wall btn visibility
  document.getElementById('add-wall-btn').style.display = commitVisibility === 'public' ? 'inline-flex' : 'none';

  // Build stamp digest for OTS
  const stampDigest = await buildStampDigest(currentCommitment);

  // Auto-save to Supabase if logged in
  if (currentUser) {
    try {
      await fetch(`${API_BASE}/api/commit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id, mac, nonce, context, domain, timestamp,
          user_id: currentUser.id,
          visibility: commitVisibility,
          psc_digest: stampDigest
        })
      });
    } catch(e) {
      console.log('Auto-save failed, manual add still works');
    }
  }

  // Fetch OTS receipt from server (may take a few seconds after anchor)
  setTimeout(async () => {
    try {
      const r = await fetch(`${API_BASE}/api/commitment/${id}`);
      if (r.ok) {
        const data = await r.json();
        if (data.ots_receipt) {
          currentCommitment.otsHex = data.ots_receipt;
        }
      }
    } catch(e) {}
  }, 3000);

  // Auto-download .psc receipt
  promptAndDownloadPSC();
}

// ‚îÄ‚îÄ COPY / DOWNLOAD ‚îÄ‚îÄ
function copyCard() {
  const text = document.getElementById('commitment-card').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    const orig = btn.textContent;
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = orig, 2000);
  });
}

function buildStampFile(commitment) {
  // This exact text is SHA256'd and submitted to OTS.
  // Also what the user drops on opentimestamps.org / dgi.io/ots to verify.
  // Message and key are NOT included ‚Äî stays private.
  return [
    'PSI-COMMIT STAMP',
    `id: ${commitment.id}`,
    `mac: ${commitment.mac}`,
    `timestamp: ${commitment.timestamp}`,
    `site: psicommit.com`,
  ].join('\n');
}

function buildPSCData(commitment) {
  // Full receipt including secret key and message ‚Äî for user download only, never sent to server
  return {
    version: '1',
    id: commitment.id,
    mac: commitment.mac,
    nonce: commitment.nonce,
    domain: commitment.domain,
    context: commitment.context,
    timestamp: commitment.timestamp,
    visibility: commitment.visibility,
    message: commitment.message,
    key: commitment.key,
    created_by: 'psicommit.com',
    _note: 'Keep this file private. The .stamp.txt + .ots files prove when this commitment was made.'
  };
}

async function sha256Hex(str) {
  const bytes = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest('SHA-256', bytes);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function buildStampDigest(commitment) {
  // SHA256 of the stamp file text ‚Äî this is what gets submitted to OTS
  return await sha256Hex(buildStampFile(commitment));
}

function promptAndDownloadFiles() {
  if (!currentCommitment) return;
  const defaultName = currentCommitment.id.replace('psc_', '');
  const name = prompt('Name your files (both .psc and .stamp.txt will use this name):', defaultName);
  if (name === null) return;
  const filename = (name.trim() || defaultName).replace(/[^a-z0-9_\-]/gi, '_');
  downloadPSCFile(filename);
  downloadStampFile(filename);
}

function promptAndDownloadPSC() {
  // Called automatically after commit ‚Äî downloads both files
  promptAndDownloadFiles();
}

function downloadPSC() {
  promptAndDownloadFiles();
}

function downloadPSCFile(filename) {
  const data = buildPSCData(currentCommitment);
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename + '.psc';
  a.click();
  URL.revokeObjectURL(url);
}

function downloadStampFile(filename, commitment = null) {
  const c = commitment || currentCommitment;
  if (!c) return;
  const text = buildStampFile(c);
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename + '.stamp.txt';
  a.click();
  URL.revokeObjectURL(url);
}

function exportOTS(commitment = null) {
  const c = commitment || currentCommitment;
  if (!c) return;

  const otsHex = c.otsHex || c.ots_receipt;
  if (!otsHex) {
    alert('OTS receipt not yet available. Bitcoin anchoring is in progress ‚Äî try again in a few minutes, or re-download from your profile once anchoring completes.');
    return;
  }

  // Convert hex to binary
  const bytes = new Uint8Array(otsHex.match(/.{1,2}/g).map(b => parseInt(b, 16)));
  const blob = new Blob([bytes], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);

  const defaultName = c.id || 'commitment';
  const name = prompt('Name your .ots file:', defaultName.replace('psc_', ''));
  if (name === null) return;
  const filename = (name.trim() || defaultName).replace(/[^a-z0-9_\-]/gi, '_');

  const a = document.createElement('a');
  a.href = url;
  a.download = filename + '.ots';
  a.click();
  URL.revokeObjectURL(url);
}

async function downloadCommitmentPSC(commitmentId) {
  // Download .psc for an existing commitment from profile page
  const { data: c } = await sb
    .from('commitments')
    .select('*')
    .eq('id', commitmentId)
    .single();

  if (!c) { alert('Commitment not found.'); return; }

  // Note: key is NOT stored server-side ‚Äî we can only include what we have
  const data = {
    version: '1',
    id: c.id,
    message: c.revealed_message || null,
    mac: c.mac,
    key: null, // not stored server-side ‚Äî user must have saved their original .psc
    nonce: c.nonce,
    domain: c.domain,
    context: c.context,
    timestamp: c.committed_at,
    visibility: c.visibility,
    ots: c.ots_receipt || null,
    bitcoin_block: c.bitcoin_block || null,
    ots_status: c.ots_status,
    note: 'Secret key not included ‚Äî retrieve from your original .psc receipt.',
    created_by: 'psicommit.com'
  };

  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = c.id + '.psc';
  a.click();
  URL.revokeObjectURL(url);
}

function downloadCommitmentStamp(commitmentId, mac, timestamp) {
  const stampText = [
    'PSI-COMMIT STAMP',
    `id: ${commitmentId}`,
    `mac: ${mac}`,
    `timestamp: ${timestamp}`,
    `site: psicommit.com`,
  ].join('\n');
  const blob = new Blob([stampText], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = commitmentId + '.stamp.txt';
  a.click();
  URL.revokeObjectURL(url);
}

async function exportCommitmentOTS(commitmentId) {
  // Export .ots for an existing commitment from profile page
  const { data: c } = await sb
    .from('commitments')
    .select('id, ots_receipt, ots_status')
    .eq('id', commitmentId)
    .single();

  if (!c?.ots_receipt) {
    alert('OTS receipt not available yet. Bitcoin anchoring is in progress.');
    return;
  }

  exportOTS({ id: c.id, otsHex: c.ots_receipt, ots_receipt: c.ots_receipt });
}

// ‚îÄ‚îÄ PARSE RECEIPT ‚îÄ‚îÄ
function parseReceipt() {
  const text = document.getElementById('verify-paste').value;
  const fields = document.getElementById('parsed-fields');

  const keyMatch = text.match(/SECRET KEY[^\n]*\n([a-f0-9]{64})/i);
  const macMatch = text.match(/MAC\s+([a-f0-9]{64})/i);
  const nonceMatch = text.match(/NONCE\s+([a-f0-9]{64})/i);
  const idMatch = text.match(/ID\s+(psc_[a-f0-9]+)/i);
  const contextMatch = text.match(/CONTEXT\s+(psi-commit\.[^\s]+)/i);

  const key = keyMatch ? keyMatch[1] : '';
  const mac = macMatch ? macMatch[1] : '';
  const nonce = nonceMatch ? nonceMatch[1] : '';
  const id = idMatch ? idMatch[1] : '';
  const context = contextMatch ? contextMatch[1].replace('psi-commit.v1.', '') : '';

  if (key || mac || nonce) {
    document.getElementById('p-key').value = key;
    document.getElementById('p-mac').value = mac;
    document.getElementById('p-nonce').value = nonce;
    document.getElementById('p-id').value = id;
    document.getElementById('p-context').value = context || 'default';
    fields.style.display = 'block';
  } else {
    fields.style.display = 'none';
  }
}

// ‚îÄ‚îÄ VERIFY ‚îÄ‚îÄ
async function verifyCommitment() {
  const message = document.getElementById('verify-message').value.trim();
  const keyHex = document.getElementById('p-key').value.trim();
  const expectedMac = document.getElementById('p-mac').value.trim();
  const nonce = document.getElementById('p-nonce').value.trim();
  const context = document.getElementById('p-context').value.trim() || 'default';

  const resultEl = document.getElementById('verify-result');
  const iconEl = document.getElementById('verify-icon');
  const msgEl = document.getElementById('verify-msg');

  if (!message) {
    resultEl.className = 'verify-result show invalid';
    iconEl.textContent = '‚úó';
    msgEl.textContent = 'Please enter the original message to verify.';
    return;
  }

  if (!keyHex || !expectedMac || !nonce) {
    resultEl.className = 'verify-result show invalid';
    iconEl.textContent = '‚úó';
    msgEl.textContent = 'Please paste your commitment receipt first.';
    return;
  }

  try {
    const domain = `psi-commit.v1.${context}`;
    const actualMac = await computeHMAC(keyHex, domain, nonce, message);
    const valid = actualMac.toLowerCase() === expectedMac.toLowerCase();

    resultEl.className = `verify-result show ${valid ? 'valid' : 'invalid'}`;
    iconEl.textContent = valid ? '‚úì' : '‚úó';
    msgEl.textContent = valid
      ? 'VERIFIED ‚Äî This commitment matches the message and key.'
      : 'FAILED ‚Äî The commitment does not match. The message or key may have been altered.';
  } catch(e) {
    resultEl.className = 'verify-result show invalid';
    iconEl.textContent = '‚úó';
    msgEl.textContent = 'Error: ' + e.message;
  }
}

// ‚îÄ‚îÄ WALL ‚îÄ‚îÄ
async function addToWall() {
  if (!currentCommitment) return;
  if (!currentUser) { openModal(); return; }

  const btn = event.target;
  const orig = btn.textContent;
  btn.textContent = 'Adding...';
  btn.disabled = true;

  try {
    const res = await fetch(`${API_BASE}/api/commit`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: currentCommitment.id,
        mac: currentCommitment.mac,
        nonce: currentCommitment.nonce,
        context: currentCommitment.context,
        domain: currentCommitment.domain,
        timestamp: currentCommitment.timestamp,
        user_id: currentUser.id,
        visibility: currentCommitment.visibility
      })
    });
    if (!res.ok) throw new Error();
    btn.textContent = '‚úì Added!';
    setTimeout(() => { switchTab('wall'); renderWall(); }, 600);
  } catch(e) {
    btn.textContent = 'Error ‚Äî try again';
    setTimeout(() => { btn.textContent = orig; btn.disabled = false; }, 2000);
  }
}

function buildWallItem(item, isOwner = false) {
  const ts = item.committed_at || item.timestamp || '';
  const commitDate = ts ? new Date(ts).toLocaleString('en-US', {month:'short',day:'numeric',year:'numeric',hour:'numeric',minute:'2-digit'}) : '';
  const revealed = item.revealed;
  const msg = revealed
    ? escapeHtml(item.revealed_message || '')
    : '<span style="color:var(--muted);font-style:italic;font-size:0.85rem">Sealed ‚Äî message hidden until reveal</span>';

  let otsLine = '';
  if (item.ots_status === 'confirmed' && item.bitcoin_block) {
    otsLine = `<div style="font-family:var(--mono);font-size:0.65rem;color:var(--accent2);margin-top:0.3rem">
      ‚õì Bitcoin block #${item.bitcoin_block}
      <a href="https://blockstream.info/block-height/${item.bitcoin_block}" target="_blank" style="color:var(--accent2);margin-left:0.4rem;opacity:0.7">verify ‚Üó</a>
    </div>`;
  } else if (item.ots_status === 'submitted') {
    otsLine = `<div style="font-family:var(--mono);font-size:0.65rem;color:#888;margin-top:0.3rem">‚è≥ Bitcoin anchoring in progress...</div>`;
  }

  // User avatar/name
  let userLine = '';
  if (item.profiles) {
    const av = item.profiles.avatar_url || getAvatarUrl(item.profiles.avatar_seed || item.user_id);
    userLine = `<div class="wall-user">
      <img class="wall-user-avatar" src="${av}" alt="" style="cursor:pointer" onclick="openUserProfile('${item.user_id}')">
      <span class="wall-user-name" onclick="openUserProfile('${item.user_id}')" style="cursor:pointer">@${escapeHtml(item.profiles.username || '')}</span>
    </div>`;
  }

  return `
  <div class="wall-item">
    <div>
      ${userLine}
      <div class="wall-id">${item.id}</div>
      <div style="font-family:var(--mono);font-size:0.65rem;color:var(--muted);margin-top:0.2rem">Committed ¬∑ ${commitDate}</div>
      ${otsLine}
      <div class="wall-message" style="margin-top:0.6rem">${msg}</div>
      <div class="wall-meta">Context: ${item.context} ¬∑ MAC: ${item.mac.substring(0,16)}...</div>
      <div style="display:flex;gap:0.5rem;margin-top:0.75rem;flex-wrap:wrap">
        ${!revealed ? `<button class="btn btn-outline" style="font-size:0.65rem;padding:0.4rem 0.9rem" onclick="revealItem('${item.id}')">Reveal</button>` : ''}
        ${revealed ? `<button class="btn btn-outline" style="font-size:0.65rem;padding:0.4rem 0.9rem;color:var(--accent2);border-color:var(--accent2)" onclick="openComments('${item.id}')">üí¨ Comments</button>` : ''}
        ${isOwner ? `<button class="btn btn-outline" style="font-size:0.65rem;padding:0.4rem 0.9rem;color:var(--accent2)" onclick="downloadCommitmentPSC('${item.id}')">‚Üì .psc</button>` : ''}
        ${isOwner ? `<button class="btn btn-outline" style="font-size:0.65rem;padding:0.4rem 0.9rem;color:var(--accent2)" onclick="downloadCommitmentStamp('${item.id}', '${item.mac}', '${item.committed_at || item.timestamp}')">‚Üì .stamp.txt</button>` : ''}
        ${isOwner ? `<button class="btn btn-outline" style="font-size:0.65rem;padding:0.4rem 0.9rem;color:var(--accent2)" onclick="exportCommitmentOTS('${item.id}')">‚Üì .ots</button>` : ''}
        ${isOwner ? `<button class="btn btn-outline" style="font-size:0.65rem;padding:0.4rem 0.9rem;color:#ff6060;border-color:#ff6060" onclick="deleteCommitment('${item.id}')">Delete</button>` : ''}
      </div>
    </div>
    <div><span class="wall-badge ${revealed ? 'badge-revealed' : 'badge-pending'}">${revealed ? 'Revealed' : 'Pending'}</span></div>
  </div>`;
}

// ‚îÄ‚îÄ SEARCH USERS ‚îÄ‚îÄ
let searchTimeout = null;
async function searchUsers(query) {
  const resultsEl = document.getElementById('search-results');
  if (!query || query.length < 2) {
    resultsEl.style.display = 'none';
    return;
  }

  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    const { data: users } = await sb
      .from('profiles')
      .select('id, username, full_name, avatar_url, avatar_seed, public_commits_count')
      .ilike('username', `%${query}%`)
      .limit(6);

    if (!users?.length) {
      resultsEl.style.display = 'none';
      return;
    }

    resultsEl.style.display = 'block';
    resultsEl.innerHTML = users.map(u => {
      const av = u.avatar_url || getAvatarUrl(u.avatar_seed || u.id);
      return `<div class="search-result-item" onclick="openUserProfile('${u.id}')">
        <img class="search-result-avatar" src="${av}" alt="">
        <div>
          <div class="search-result-name">${escapeHtml(u.full_name || u.username)}</div>
          <div class="search-result-handle">@${escapeHtml(u.username)} ¬∑ ${u.public_commits_count || 0} commits</div>
        </div>
      </div>`;
    }).join('');
  }, 300);
}

function openUserProfile(userId) {
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('user-search').value = '';
  showProfile(userId);
}

// Close search results on outside click
document.addEventListener('click', function(e) {
  if (!e.target.closest('#user-search') && !e.target.closest('#search-results')) {
    const r = document.getElementById('search-results');
    if (r) r.style.display = 'none';
  }
});

async function renderWall() {
  const grid = document.getElementById('wall-grid');
  const empty = document.getElementById('wall-empty');

  try {
    const res = await fetch(`${API_BASE}/api/wall`);
    if (res.ok) {
      const data = await res.json();
      wallItems = data.commitments || [];
    }
  } catch(e) {}

  const publicItems = wallItems.filter(w => !w.visibility || w.visibility === 'public');

  if (!publicItems.length) {
    empty.style.display = 'block';
    grid.style.display = 'none';
    return;
  }

  empty.style.display = 'none';
  grid.style.display = 'grid';
  grid.innerHTML = publicItems.map(item => buildWallItem(item)).join('');
}

async function revealItem(commitmentId) {
  const receipt = prompt(`Paste your full commitment receipt for ${commitmentId}:`);
  if (!receipt) return;
  const message = prompt('Enter your original message:');
  if (!message) return;

  const keyMatch = receipt.match(/([a-f0-9]{64})\s*$/im);
  const nonceMatch = receipt.match(/NONCE\s+([a-f0-9]{64})/i);

  if (!keyMatch || !nonceMatch) {
    alert('Could not parse receipt.');
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/api/reveal/${commitmentId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: commitmentId, message, key_hex: keyMatch[1] })
    });
    if (res.ok) {
      renderWall();
    } else {
      const err = await res.json();
      alert(err.detail || 'Verification failed');
    }
  } catch(e) {
    alert('Error revealing commitment');
  }
}

// ‚îÄ‚îÄ EDIT PROFILE ‚îÄ‚îÄ
function openEditProfile() {
  if (!currentProfile) return;
  document.getElementById('edit-username').value = currentProfile.username || '';
  document.getElementById('edit-displayname').value = currentProfile.full_name || '';
  document.getElementById('edit-bio').value = currentProfile.bio || '';
  document.getElementById('edit-username-feedback').textContent = '';
  document.getElementById('edit-profile-modal').classList.add('open');
}

function closeEditProfile() {
  document.getElementById('edit-profile-modal').classList.remove('open');
}

function validateEditUsername() {
  const u = document.getElementById('edit-username').value.trim().toLowerCase();
  const feedback = document.getElementById('edit-username-feedback');
  if (!u) { feedback.textContent = ''; return; }
  if (u.length < 3) { feedback.textContent = 'At least 3 characters.'; feedback.style.color = '#ff6060'; }
  else if (u.length > 20) { feedback.textContent = 'Max 20 characters.'; feedback.style.color = '#ff6060'; }
  else if (!/^[a-z0-9_]+$/.test(u)) { feedback.textContent = 'Only letters, numbers, underscores.'; feedback.style.color = '#ff6060'; }
  else { feedback.textContent = '‚úì Looks good'; feedback.style.color = 'var(--accent)'; }
}

async function saveProfile() {
  const btn = document.getElementById('save-profile-btn');
  const username = document.getElementById('edit-username').value.trim().toLowerCase();
  const fullName = document.getElementById('edit-displayname').value.trim();
  const bio = document.getElementById('edit-bio').value.trim();

  if (!/^[a-z0-9_]{3,20}$/.test(username)) {
    document.getElementById('edit-username-feedback').textContent = 'Invalid username.';
    document.getElementById('edit-username-feedback').style.color = '#ff6060';
    return;
  }

  btn.textContent = 'Saving...';
  btn.disabled = true;

  // Check uniqueness if username changed
  if (username !== currentProfile.username) {
    const { data: taken } = await sb.from('profiles').select('id').eq('username', username).single();
    if (taken) {
      document.getElementById('edit-username-feedback').textContent = 'Username taken.';
      document.getElementById('edit-username-feedback').style.color = '#ff6060';
      btn.textContent = 'Save Changes ‚Üí';
      btn.disabled = false;
      return;
    }
  }

  const { data: updated, error } = await sb
    .from('profiles')
    .update({ username, full_name: fullName, bio })
    .eq('id', currentUser.id)
    .select()
    .single();

  if (error) {
    alert('Error saving profile: ' + error.message);
    btn.textContent = 'Save Changes ‚Üí';
    btn.disabled = false;
    return;
  }

  currentProfile = updated;
  document.getElementById('nav-username').textContent = '@' + username;
  closeEditProfile();
  await loadProfileData();

  btn.textContent = 'Save Changes ‚Üí';
  btn.disabled = false;
}

async function confirmDeleteAccount() {
  if (!confirm('Are you sure you want to delete your account? This cannot be undone.')) return;
  if (!confirm('All your commitments will remain on the wall but will be unlinked from your account. Confirm deletion?')) return;

  await sb.from('profiles').delete().eq('id', currentUser.id);
  await sb.auth.signOut();
  showMainPage();
}

// ‚îÄ‚îÄ DELETE COMMITMENT ‚îÄ‚îÄ
async function deleteCommitment(commitmentId) {
  if (!confirm('Delete this commitment? It will be removed from your profile and the wall.')) return;

  try {
    const res = await fetch(`${API_BASE}/api/commitment/${commitmentId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json', 'x-user-id': currentUser?.id || '' }
    });

    if (res.ok) {
      // Reload current view
      if (document.getElementById('profile-page').classList.contains('active')) {
        await loadProfileData(viewingUserId);
      } else {
        renderWall();
      }
    } else {
      // Fallback: delete directly via Supabase if user owns it
      await sb.from('commitments').delete().eq('id', commitmentId).eq('user_id', currentUser.id);
      if (document.getElementById('profile-page').classList.contains('active')) {
        await loadProfileData(viewingUserId);
      } else {
        renderWall();
      }
    }
  } catch(e) {
    await sb.from('commitments').delete().eq('id', commitmentId).eq('user_id', currentUser.id);
    await loadProfileData(viewingUserId);
  }
}

// ‚îÄ‚îÄ COMMENTS ‚îÄ‚îÄ
let currentCommentsId = null;

async function openComments(commitmentId) {
  currentCommentsId = commitmentId;
  document.getElementById('comments-commitment-id').textContent = commitmentId;
  document.getElementById('comments-modal').classList.add('open');

  if (currentUser) {
    document.getElementById('comments-input-area').style.display = 'block';
    document.getElementById('comments-login-prompt').style.display = 'none';
  } else {
    document.getElementById('comments-input-area').style.display = 'none';
    document.getElementById('comments-login-prompt').style.display = 'block';
  }

  await loadComments(commitmentId);
}

async function loadComments(commitmentId) {
  const { data: comments } = await sb
    .from('comments')
    .select('id, content, created_at, user_id, profiles(username, avatar_url, avatar_seed)')
    .eq('commitment_id', commitmentId)
    .order('created_at', { ascending: true });

  const listEl = document.getElementById('comments-list');

  if (!comments?.length) {
    listEl.innerHTML = '<div style="font-family:var(--mono);font-size:0.75rem;color:var(--muted);text-align:center;padding:1.5rem 0">No comments yet. Be the first.</div>';
    return;
  }

  listEl.innerHTML = comments.map(c => {
    const av = c.profiles?.avatar_url || getAvatarUrl(c.profiles?.avatar_seed || c.user_id);
    const time = new Date(c.created_at).toLocaleString('en-US', {month:'short',day:'numeric',hour:'numeric',minute:'2-digit'});
    return `<div class="comment-item">
      <div class="comment-header">
        <img class="comment-avatar" src="${av}" alt="">
        <span class="comment-username" onclick="openUserProfile('${c.user_id}')">@${escapeHtml(c.profiles?.username || '')}</span>
        <span class="comment-time">${time}</span>
      </div>
      <div class="comment-text">${escapeHtml(c.content)}</div>
    </div>`;
  }).join('');
}

async function submitComment() {
  if (!currentUser) { openModal(); return; }
  const content = document.getElementById('comment-input').value.trim();
  if (!content) return;

  const { error } = await sb.from('comments').insert({
    commitment_id: currentCommentsId,
    user_id: currentUser.id,
    content
  });

  if (error) { alert('Error posting comment: ' + error.message); return; }

  document.getElementById('comment-input').value = '';
  await loadComments(currentCommentsId);
}

// ‚îÄ‚îÄ OTS FILE VERIFICATION ‚îÄ‚îÄ
let otsFileBytes = null;
let stampFileText = null;

function handleOTSDrop(e) {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if (file) handleOTSFile(file);
}

function handleStampDrop(e) {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if (file) handleStampFile(file);
}

function handleOTSFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    otsFileBytes = new Uint8Array(e.target.result);
    const zone = document.getElementById('ots-drop-zone');
    zone.classList.add('loaded');
    document.getElementById('ots-drop-label').textContent = `‚úì ${file.name} (${otsFileBytes.length} bytes)`;
    checkOTSReady();
  };
  reader.readAsArrayBuffer(file);
}

function handleStampFile(file) {
  const reader = new FileReader();
  reader.onload = (e) => {
    stampFileText = e.target.result;
    const zone = document.getElementById('stamp-drop-zone');
    zone.classList.add('loaded');
    document.getElementById('stamp-drop-label').textContent = `‚úì ${file.name}`;
    checkOTSReady();
  };
  reader.readAsText(file);
}

function checkOTSReady() {
  const btn = document.getElementById('verify-ots-btn');
  if (otsFileBytes && stampFileText) {
    btn.disabled = false;
    btn.style.opacity = '1';
  }
}

async function verifyOTS() {
  const resultEl = document.getElementById('ots-verify-result');
  const iconEl = document.getElementById('ots-verify-icon');
  const msgEl = document.getElementById('ots-verify-msg');

  resultEl.style.display = 'flex';
  resultEl.className = 'verify-result show';
  iconEl.textContent = '‚è≥';
  msgEl.textContent = 'Verifying Bitcoin timestamp...';

  try {
    // Step 1: SHA256 the stamp file
    const stampBytes = new TextEncoder().encode(stampFileText);
    const stampHashBuf = await crypto.subtle.digest('SHA-256', stampBytes);
    const stampHash = new Uint8Array(stampHashBuf);
    const stampHex = Array.from(stampHash).map(b => b.toString(16).padStart(2, '0')).join('');

    // Step 2: Parse stamp file to show what it contains
    const lines = stampFileText.trim().split('\n');
    const stampData = {};
    lines.forEach(l => {
      const idx = l.indexOf(': ');
      if (idx > -1) stampData[l.slice(0, idx)] = l.slice(idx + 2);
    });

    // Step 3: Send .ots and stamp digest to our backend for verification
    const otsHex = Array.from(otsFileBytes).map(b => b.toString(16).padStart(2, '0')).join('');

    const res = await fetch(`${API_BASE}/api/ots/verify`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ots_hex: otsHex, stamp_digest: stampHex })
    });

    const data = await res.json();

    if (data.status === 'confirmed') {
      resultEl.className = 'verify-result show valid';
      iconEl.textContent = '‚úì';
      msgEl.innerHTML = `Bitcoin Timestamp Verified<br>
        <span style="font-size:0.75rem;color:#999;font-family:var(--mono)">
          Commitment ID: ${escapeHtml(stampData['id'] || '‚Äî')}<br>
          Bitcoin block: #${data.bitcoin_block}<br>
          Stamp digest: ${stampHex.slice(0, 16)}...<br>
          <a href="https://blockstream.info/block-height/${data.bitcoin_block}" target="_blank" style="color:var(--accent2)">View block on blockstream.info ‚Üó</a>
        </span>`;
    } else if (data.status === 'pending') {
      resultEl.className = 'verify-result show';
      iconEl.textContent = '‚è≥';
      msgEl.innerHTML = `Pending Bitcoin Confirmation<br>
        <span style="font-size:0.75rem;color:#999;font-family:var(--mono)">
          The .ots file is valid but Bitcoin anchoring is still in progress.<br>
          Usually takes 1-2 hours. Try again later.
        </span>`;
    } else {
      resultEl.className = 'verify-result show invalid';
      iconEl.textContent = '‚úó';
      msgEl.textContent = data.message || 'Verification failed ‚Äî the .ots and .stamp.txt files do not match.';
    }
  } catch(e) {
    resultEl.className = 'verify-result show invalid';
    iconEl.textContent = '‚úó';
    msgEl.textContent = 'Error during verification: ' + e.message;
  }
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ
function escapeHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', async () => {

  // First check for existing persisted session
  const { data: { session: existingSession } } = await sb.auth.getSession();
  if (existingSession?.user) {
    currentUser = existingSession.user;
    await ensureProfile(existingSession.user);
    updateAuthUI(existingSession.user);
  }

  // Then listen for auth changes (Google redirect, sign out, etc)
  sb.auth.onAuthStateChange(async (event, session) => {
    console.log('[AUTH] event:', event, 'user:', session?.user?.email);
    if (event === 'SIGNED_OUT') {
      currentUser = null;
      currentProfile = null;
      updateAuthUI(null);
      return;
    }
    if (session?.user && session.user.id !== currentUser?.id) {
      currentUser = session.user;
      await ensureProfile(session.user);
      updateAuthUI(session.user);
    }
  });

  // Handle wall invite links (/wall/{code})
  const handledWall = await handleWallInviteLink();
  if (!handledWall) {
    renderWall();
  }
  setVisibility('public');
});

// Communities placeholder (built in directory phase)
async function loadMyCommunities() {
  const container = document.getElementById('my-communities-container');
  if (!container || !currentUser) return;
  const { data } = await sb.from('community_members')
    .select('community_id, communities(id, name, description, member_count)')
    .eq('user_id', currentUser.id);
  if (!data?.length) {
    container.innerHTML = '<div class="wall-empty">No communities joined yet. <button class="btn btn-outline" onclick="showDirectory()" style="font-size:0.7rem;padding:0.3rem 0.8rem;margin-left:0.5rem">Browse Directory</button></div>';
    return;
  }
  container.innerHTML = '<div style="display:flex;flex-direction:column;gap:0.75rem">' +
    data.map(m => m.communities).filter(Boolean).map(c => `
    <div style="border:1px solid var(--border);padding:1rem;display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-family:var(--display);font-size:1.2rem">${c.name}</div>
        <div style="color:#999;font-size:0.8rem">${c.member_count} members</div>
      </div>
      <button class="btn btn-outline" onclick="showDirectory()" style="font-size:0.68rem">View ‚Üí</button>
    </div>`).join('') + '</div>';
}

function showDirectory() {
  // Placeholder ‚Äî will be built in directory phase
  alert('Directory coming soon!');
}
</script>
</body>
</html>
